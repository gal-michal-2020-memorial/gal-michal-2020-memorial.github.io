var FlipTemplates={flipPageNavigation:'<div class="page-navigation-view" ignore="1"><% if(!player) { %><div class="flip-previous-page nav-button"><svg class="nav-button" width="36" height="93" viewBox="0 0 36 93" xmlns="http://www.w3.org/2000/svg"><path class="nav-button" d="M29.958 0L0 46.035l29.958 46.02H36L6.042 46.035 36 0z" /></svg></div><div class="flip-next-page nav-button"><svg class="nav-button" width="36" height="93" viewBox="0 0 36 93" xmlns="http://www.w3.org/2000/svg"><path class="nav-button" d="M6.042 0L36 46.035 6.042 92.055H0l29.958-46.02L0 0z" /></svg></div><% } else { %><div class="flip-previous-page nav-button previous-player"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="47" viewBox="0 0 33 54"><path d="M.967 25.44l19.338 19.906c1.29 1.267 2.438 1.267 3.728 0 1.29-1.266 1.29-2.392 0-3.658L6.087 23.148l17.945-18.54c1.29-1.266 1.29-2.392 0-3.658-1.29-1.267-2.437-1.267-3.727 0L.967 20.856a3.2 3.2 0 000 4.584z" fill="#FFF" fill-rule="evenodd"/></svg></div><div class="flip-next-page nav-button next-player"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="47" viewBox="0 0 33 54"><path d="M24.033 25.44L4.695 45.346c-1.29 1.267-2.438 1.267-3.728 0-1.29-1.266-1.29-2.392 0-3.658l17.946-18.54L.968 4.608C-.322 3.342-.322 2.216.968.95c1.29-1.267 2.437-1.267 3.727 0l19.338 19.906a3.2 3.2 0 010 4.584z" fill="#FFF" fill-rule="evenodd"/></svg></div><% } %></div>',flipItemNavigation:'<div class="left-container"><span class="action"><i></i> <%- prevlabel %></span></div><div class="right-container"><span class="action"><%- nextlabel %> <i></i></span></div>',leftPageContainer:'<div class="hardcover-gradient"></div><div class="gradient"></div><div class="page-content"><div class="image-container"></div><div class="link-container"></div><div class="custom-content-container"></div></div>',rightPageContainer:'<div class="hardcover-gradient"></div><div class="even"><div class="gradient"></div></div><div class="gradient"></div><div class="page-content"><div class="image-container"></div><div class="link-container"></div><div class="custom-content-container"></div></div>',documentViewContainer:'<div id="viewLimiter"><div id="docView"></div></div>'},FlipEvents={PREVIOUS_ITEM:"previousItem",NEXT_ITEM:"nextItem",PREVIOUS_PAGE:"previousPage",NEXT_PAGE:"nextPage",FLIP_START:"flipStart",FLIP_END:"flipEnd",FLIP_TAP:"flipTap",FLIP_POSITIONED:"flipPositioned"},DocumentModel=Backbone.Model.extend({defaults:{collectionSize:[640,385],maxSize:[640,385],displayType:"small",item:void 0,currentPageIndex:0,offset:{},navButtonWidth:40,singlePageView:!1,arabicStyle:!1,enableSounds:!1,showPageShadows:!1,mergePdfs:!1,retryFirstImage:!1,status:ContentLoaderStatus.IDLE}}),ItemNavigationView=Backbone.View.extend({events:function(){return FSUtils.isMobileDevice()?{"touchend .left-container span":"previousItem","touchend .right-container span":"nextItem"}:{"click .left-container span":"previousItem","click .right-container span":"nextItem"}},id:"itemNavigationView",template:_.template(FlipTemplates.flipItemNavigation),initialize:function(){this.listenTo(this.model,"change:collectionSize",this.resize),this.listenTo(this.model,"change:totalItems",this.render),this.listenTo(this.model,"change:currentItem",this.render),this.listenTo(FSWidgetModel.gi(),"change:labels",this.updateLabels),this.resize()},render:function(){return this.$el.html(this.template(this.model.attributes)),0===this.model.get("currentItem")?(this.$el.find(".left-container span").hide(),this.$el.find(".right-container span").show()):this.model.get("currentItem")===this.model.get("totalItems")-1?(this.$el.find(".left-container span").show(),this.$el.find(".right-container span").hide()):(this.$el.find(".left-container span").show(),this.$el.find(".right-container span").show()),this},updateLabels:function(){this.model.set({prevlabel:FSWidgetModel.gi().get("labels").l_prevLabelText,nextlabel:FSWidgetModel.gi().get("labels").l_nextLabelText}),this.render()},resize:function(){this.model.get("collectionSize")[0]<FlipView.SMALL_MAX_WIDTH||this.model.get("collectionSize")[1]<FlipView.SMALL_MAX_HEIGHT?this.$el.addClass("small"):this.$el.removeClass("small")},show:function(){this.$el.show()},hide:function(){this.$el.hide()},getHeight:function(){return this.$el.height()+parseInt(this.$el.css("margin-top"),10)+parseInt(this.$el.css("margin-bottom"),10)},previousItem:function(){this.trigger(FlipEvents.PREVIOUS_ITEM)},nextItem:function(){this.trigger(FlipEvents.NEXT_ITEM)},remove:function(){this.$el.find(".left-container span").off(),this.$el.find(".right-container span").off(),Backbone.View.prototype.remove.apply(this,arguments)}}),PageNavigationView=Backbone.View.extend({events:function(){var eventName=FSUtils.isMobileDevice()?"touchend":"click",eventsObj={};return eventsObj[eventName+" .flip-previous-page"]="previousPage",eventsObj[eventName+" .flip-next-page"]="nextPage",eventsObj},template:_.template(FlipTemplates.flipPageNavigation),initialize:function(){this.isPlayerSkin=FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.PLAYER,this.setElement(this.template({player:this.isPlayerSkin})),this.previousButton=this.$el.find(".flip-previous-page"),this.nextButton=this.$el.find(".flip-next-page"),this.isMobileDeveice=FSUtils.isMobileDevice(),this.isSmall=!0,this.isZoomed=!1,this.listenTo(this.model,"change",this.modelChanged),Backbone.Mediator.sub(WidgetEvent.ZOOM_CHANGED,this.handleZoomChanged,this),Backbone.Mediator.sub(WidgetEvent.ZOOM_END,this.handleZoomChanged,this),this.resize()},modelChanged:function(){("collectionSize"in this.model.changed||"maxHeight"in this.model.changed||"fullHeight"in this.model.changed||"displayType"in this.model.changed)&&this.resize(),("totalPages"in this.model.changed||"isBuyCurtainDisplayed"in this.model.changed)&&this.render(),("navDistance"in this.model.changed||"maxHeight"in this.model.changed||"flipViewLeft"in this.model.changed)&&this.positionButtons()},render:function(){return this.model.get("isBuyCurtainDisplayed")?(this.hidePrevious(),this.hideNext(),this):(0===this.model.get("currentPage")?(this.hidePrevious(),this.showNext()):this.model.get("currentPage")===this.model.get("totalPages")-1?(this.showPrevious(),this.hideNext()):(this.showPrevious(),this.showNext()),this)},showPrevious:function(){this.previousButton.css("opacity",1)},hidePrevious:function(){this.previousButton.css("opacity",0)},showNext:function(){this.nextButton.css("opacity",1)},hideNext:function(){this.nextButton.css("opacity",0)},resize:function(){},previousPage:function(){this.trigger(FlipEvents.PREVIOUS_PAGE)},nextPage:function(){this.trigger(FlipEvents.NEXT_PAGE)},positionButtons:function(){var singlePage=FSWidgetModel.gi().widgetSettings.get("singlePageView"),w=this.$el.width(),navWidth=this.getNavButtonWidth(),flipWidth=this.model.get("navDistance"),marginDistance=Math.ceil((w-flipWidth)/2)-navWidth,svgHeight=FSWidgetModel.gi().get("height")/10;FSWidgetModel.gi().get("currentZoom")>0?this.positionButtonsInZoom():(singlePage&&FSUtils.isInFullScreen()&&FSUtils.isPortrait()?this.$el.removeClass("visible"):this.$el.addClass("visible"),singlePage||this.$el.removeClass("visible"),this.previousButton.css({left:singlePage?marginDistance+"px":-navWidth+"px",width:navWidth+"px"}),this.nextButton.css({right:singlePage?marginDistance+"px":-navWidth+"px",width:navWidth+"px"}),this.previousButton.children().css("height",svgHeight),this.nextButton.children().css("height",svgHeight))},positionButtonsInZoom:function(){this.previousButton.css({left:"0"}),this.nextButton.css({right:"0"})},remove:function(){this.previousButton.off(),this.nextButton.off(),Backbone.View.prototype.remove.apply(this,arguments)},getNavButtonWidth:function(){return Math.ceil(this.model.get("maxHeight")/10)},getButtonsTotalWidth:function(){return 2*this.getNavButtonWidth()},handleZoomChanged:function(){var currentZoom=FSWidgetModel.gi().get("currentZoom");this.positionButtons(),currentZoom>0&&!1===this.isZoomed?this.isZoomed=!0:0===currentZoom&&!0===this.isZoomed&&(this.isZoomed=!1)}}),DocumentView=Backbone.View.extend({events:function(){return FSUtils.isIOS()?{"touchstart #viewLimiter":"mouseDownDocView","touchend #viewLimiter":"mouseUpDocView"}:{"mouseover .page-wrapper":"mouseOverPage","mouseout .page-wrapper":"mouseOutPage","mouseenter #viewLimiter":"mouseEnterView","mousemove #viewLimiter":"mouseMoveDocView","mousedown #viewLimiter":"mouseDownDocView","mouseup #viewLimiter":"mouseUpDocView"}},template:_.template(FlipTemplates.documentViewContainer),id:"docContainer",initialize:function(){this.$el.html(this.template()),this.arabicStyle=this.model.get("arabicStyle"),this.isMobileDevice=FSUtils.isMobileDevice(),this.isIOS=FSUtils.isIOS(),this.singlePageView=this.model.get("singlePageView"),this.docContainer=this.$el,this.viewLimiter=this.$el.find("#viewLimiter"),this.flipbook=this.$el.find("#docView"),this.customContent={},this.pagesToStopCustomContentOn=[],this.flipSoundUrl=URLPaths.ASSETS_PATH+"page_flip.mp3",this.soundEnabled=!1,this.soundMuted=!1,this.currentZoom=0,this.firstImageRetries=5,this.flipTotalPages=FSWidgetModel.gi().flipCollection.totalPages,this.documentViewObj={},this.pdfLinks={},this.updateSoundSettings(),this.disableRightClick(),this.listenTo(this.model,"change:maxSize",this.resize),this.listenTo(this.model,"change:item",this.initDocumentView),this.listenTo(this.model,"change:currentPageIndex",this.pageChanged),this.listenTo(this.model,"change:singlePageView",this.initDocumentView),this.listenTo(this.model,"change:enableSounds",this.updateSoundSettings),this.listenTo(this.model,"change:showPageShadows",this.setGradientVisibility),Backbone.Mediator.sub(WidgetEvent.LEAD_FORM_SENT,this.closeForm,this),Backbone.Mediator.sub(WidgetEvent.PDF_LINKS_LOADED,this.pdfLinksLoaded,this),Backbone.Mediator.sub(WidgetEvent.MUTE,this.muteFlipSound,this),Backbone.Mediator.sub(WidgetEvent.UN_MUTE,this.unmuteFlipSound,this),Backbone.Mediator.sub(ShelfEvents.SHELF_OPENED,this.handleShelfOpened,this),Backbone.Mediator.sub(ShelfEvents.SHELF_CLOSED,this.handleShelfClosed,this),Backbone.Mediator.sub(WidgetEvent.PREVIEW_PAGES_UPDATED,this.updatePreviewPages,this),Backbone.Mediator.sub(NewShelfEvents.CLOSE_ITEM,this.destroyFlippingBookView,this),this.isMobileDevice?(Backbone.Mediator.sub(WidgetEvent.ZOOM_CHANGED,this.oldDesktopHandleZoomChanged,this),Backbone.Mediator.sub(WidgetEvent.ZOOM_END,this.oldDesktopHandleZoomEnd,this)):(Backbone.Mediator.sub(WidgetEvent.ZOOM_CHANGED,this.oldDesktopHandleZoomChanged,this),Backbone.Mediator.sub(WidgetEvent.ZOOM_END,this.oldDesktopHandleZoomEnd,this),this.initFlipSound(),$(document.body).on("mouseleave",$.proxy(this,"mouseOutBody")),$(document.body).on("mouseup",$.proxy(this,"mouseUpBody")),this.flipbook.on("dblclick",$.proxy(this,"enterZoom")),this.flipbook.on("mousewheel",$.proxy(this,"handleMouseWheel")))},initFlipSound:function(){this.flipSound=document.createElement("audio"),this.flipSound.id="flipSound",this.flipSound.preload="auto",this.flipSound.style.position="absolute",this.flipSound.src=this.flipSoundUrl},playFlipSound:function(){var playPromise;this.flipSound&&this.soundEnabled&&!this.soundMuted&&(0===this.flipSound.currentTime||this.flipSound.currentTime>=.3)&&(this.flipSound.currentTime=0,"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?void 0!==(playPromise=this.flipSound.play())&&playPromise.then(function(){}).catch(function(){}):this.flipSound.play())},updateSoundSettings:function(){this.soundEnabled=this.model.get("enableSounds")},muteFlipSound:function(){this.soundMuted=!0},unmuteFlipSound:function(){this.soundMuted=!1},destroySound:function(){this.flipSound&&(this.flipSound.pause(),this.flipSound.src="",this.flipSound=null)},render:function(){return this.initDocumentView(),this},resize:function(pageSizes){this.oldResize(pageSizes)},setDocumentMaxZoom:function(){FSWidgetModel.gi().set("maxZoomValue",DocumentView.MAX_ZOOM_VALUE)},setCustomContentPageSize:function(){this.oldSetCustomContentPageSize()},initDocumentView:function(){this.closeForm(),this.isInFullScreen=FSUtils.isInFullScreen(),this.totalItemPages=this.model.get("item").get("pages").length,this.singlePageView=this.model.get("singlePageView"),this.isDoublePageLayout=FSWidgetModel.gi().flipCollection.get("isDoublePageLayout"),this.isSinglePageLayout=FSWidgetModel.gi().widgetSettings.get("contentLayout")===ContentLayout.SINGLE_PAGE,this.isSmartViewLayout=FSWidgetModel.gi().widgetSettings.get("contentLayout")===ContentLayout.SMART_VIEW,this.flipbook.turn&&this.flipbook.turn("pages")>0&&this.destroyFlippingBookView(),this.singlePageView?this.$el.addClass("single-page-view"):this.$el.removeClass("single-page-view"),this.arabicStyle?this.$el.addClass("right-to-left"):this.$el.removeClass("right-to-left"),!FSWidgetModel.gi().widgetSettings.get("singlePageView")&&this.flipTotalPages>1&&this.flipbook.append(this.model.get("navigationView").render().$el),this.loadFonts(),this.calculatePageSize(),this.createFlippingBookView(),this.resize(!0),this.flipbook.turn.initialLoading||(this.flipbook.turn.initialLoading=!0),this.setDocumentMaxZoom(),Backbone.Mediator.pub(WidgetEvent.ITEM_VIEW_INIT)},createFlippingBookView:function(){var self=this;this.flipbook.turn({display:"double",width:this.pageWidth,height:this.pageHeight,duration:PAGE_TURN_DURATION,acceleration:!1,gradients:!0,autoCenter:!this.singlePageView,cornerSize:this.isMobileDevice?0:100,elevation:50,page:this.model.get("currentPageIndex")+1,pages:this.totalItemPages,isDoublePageLayout:this.isDoublePageLayout,when:{start:function(event,pageObj,corner){self.handleTurnStart(event,pageObj,corner)},turning:function(event,page,view){self.handleTurning(event,page-1,view)},turned:function(event,page){self.handleTurned(event,page-1)},missing:function(event,pages){self.handleMissing(event,pages)},end:function(event,pageObj,pageTurned){self.handleTurnEnd(event,pageObj,pageTurned)},afterOverflowEnabled:function(event,data){self.handleAfterOverflowEnabled(data)},afterOverflowDisabled:function(event,data){self.handleAfterOverflowDisabled(data)}}}),this.initPdflinks()},setGradientVisibility:function(){this.model.get("showPageShadows")?this.$el.find(".page .gradient").show():this.$el.find(".page .gradient").hide()},pdfLinksLoaded:function(){this.removePdfLinks(),window.linksJs&&this.showPdfLinks(this.model.get("currentPageIndex"))},removePdfLinks:function(){$.each(this.pdfLinks,function(i,pagesLinks){$.each(pagesLinks,function(j,link){link.remove(),link=null})}),this.pdfLinks={}},showPdfLinks:function(pageIndex){this.pdfLinks[pageIndex]?this.pdfLinksDelegateEvents(pageIndex):this.generatePdfLinks(pageIndex),this.isLeftPage(pageIndex)||0===pageIndex||(this.pdfLinks[pageIndex-1]?this.pdfLinksDelegateEvents(pageIndex-1):this.generatePdfLinks(pageIndex-1)),this.isLeftPage(pageIndex)&&pageIndex<this.totalItemPages-1&&(this.pdfLinks[pageIndex+1]?this.generatePdfLinks(pageIndex+1):this.pdfLinksDelegateEvents(pageIndex+1))},pdfLinksDelegateEvents:function(pageIndex){$.each(this.pdfLinks[pageIndex],function(i,link){link.delegateEvents()}),this.resizePdfLinksContainer(pageIndex)},generatePdfLinks:function(pageIndex){var pageModel,pdfPageIdx,pageContainer,pageImage,pdfLinksContainer,scale,mergePdfs,self=this;window.linksJs&&(this.singlePageView&&(!this.arabicStyle&&this.isLeftPage(pageIndex)||this.arabicStyle&&!this.isLeftPage(pageIndex))||(pageModel=this.model.get("item").get("pages").at(pageIndex),pageImage=(pageContainer=this.getPageContainer(pageIndex+1)).find("img.page-image"),mergePdfs=this.model.get("mergePdfs"),pageModel&&parseInt(pageModel.get("type"),10)!==PageType.EMPTY_PAGE&&pageContainer.length&&pageImage.length&&(pdfPageIdx=mergePdfs?this.singlePageView?this.arabicStyle?Math.floor(pageIndex/2):Math.ceil(pageIndex/2):pageIndex:parseInt(pageModel.get("pdfidx"),10),window.linksJs[pdfPageIdx]&&(mergePdfs||pageModel.get("type")!==PageType.MOVED_PAGE||window.linksJs[pageIndex])&&(this.pdfLinks[pageIndex]?this.pdfLinksDelegateEvents(pageIndex):window.linksJs[pdfPageIdx]&&(pageContainer.find(".pdf-links").length||this.createPdfLinkContainer(pageContainer),pdfLinksContainer=this.getPdfLinksContainer(pageIndex),this.pdfLinks[pageIndex]=[],scale=self.getPageScale(pageIndex),this.resizePdfLinksContainer(pageIndex),$.each(window.linksJs[pdfPageIdx],function(i,linkParams){var model=_.extend(linkParams,{scale:scale,pageIndex:pageIndex,linkIndex:i}),pdfLink=new PdfLinkView({model:new Backbone.Model(model)});self.pdfLinks[pageIndex].push(pdfLink),pdfLinksContainer.append(pdfLink.render().$el)}))))))},resizePdfLinksContainer:function(pageIndex,resizeElements){var pageContainer=this.getPageContainer(pageIndex+1),pageImage=pageContainer.find("img.page-image"),css={width:pageImage.width()+"px",height:pageImage.height()+"px",top:pageImage.css("top"),left:pageImage.css("left")};pageContainer.find(".pdf-links").css(css),resizeElements&&this.resizePdfLinks(pageIndex)},createPdfLinkContainer:function(pageContainer){var pdfLinkContainer=$('<div class="pdf-links" />');pageContainer.find(".link-container").append(pdfLinkContainer)},getPdfLinksContainer:function(pageIndex){return this.getPageContainer(pageIndex+1).find(".pdf-links")},resizePdfLinks:function(pageIndex){var scale;this.pdfLinks&&this.pdfLinks[pageIndex]&&(scale=this.getPageScale(pageIndex),$.each(this.pdfLinks[pageIndex],function(i,link){link.resize(scale)}))},initPdflinks:function(){var canInit=!1;this.model.get("mergePdfs")?$.each(FSWidgetModel.gi().get("collectionData").collection,function(i,collectionItem){return"pdf"!==collectionItem.extension||(canInit=!0,!1)}):"pdf"===FSWidgetModel.gi().widgetState.get("currentItem").get("extension")&&(canInit=!0),canInit&&(new PdfLinks).get()},handleAfterOverflowEnabled:function(data){this.isDoublePageLayout&&data.page>1&&this.toggleLeftPageCustomContent(data,!0)},handleAfterOverflowDisabled:function(data){this.isDoublePageLayout&&data.page>1&&this.toggleLeftPageCustomContent(data,!1)},toggleLeftPageCustomContent:function(data,showContent){var leftPage=data.page%2==0?data.page:data.page-1,leftPages=[leftPage];leftPage-2>1&&leftPages.push(leftPage-2),leftPage+2<this.flipTotalPages&&leftPages.push(leftPage+2);for(var i=0;i<leftPages.length;i++)showContent?this.$el.find(".even .custom-content").show():this.$el.find(".even .custom-content").hide()},handleTurnStart:function(event,pageObj,corner){var blockedCorners;if(1!==this.flipTotalPages)if(blockedCorners=this.getPageBlockedCorners(pageObj.page-1),this.setGradientVisibility(),this.resizePageContents(),blockedCorners&&blockedCorners.indexOf(corner)>-1||this.currentZoom>0)event.preventDefault();else{if(this.singlePageView){if(this.arabicStyle&&2===pageObj.page)return void event.preventDefault();if(!this.arabicStyle){if(pageObj.page===this.totalItemPages-1)return void event.preventDefault();pageObj.next%2==0&&this.$(".page.p"+pageObj.next).addClass("turning")}}if(this.isDoublePageLayout&&pageObj.page>1){var leftPage=pageObj.page%2==0?pageObj.page:pageObj.page-1,leftCustomContent=this.getPageContainer(leftPage).find(".custom-content");leftCustomContent&&leftCustomContent.length&&leftCustomContent.show()}Backbone.Mediator.pub(WidgetEvent.PAGE_TURN_START,{previousPageIndex:pageObj.page-1,nextPageIndex:pageObj.next-1})}else event.preventDefault()},handleTurnEnd:function(event,pageObj,pageTurned){pageTurned?pageObj.next%2==0&&this.$(".page.p"+pageObj.next).removeClass("turning"):Backbone.Mediator.pub(WidgetEvent.PAGE_TURN_CANCELED,pageObj)},handleTurning:function(event,pageIndex,view){if(1!==this.flipTotalPages)if(this.getIfNextNavIsBlocked(this.arabicStyle,this.flipbook.turn("page"),view[0]))event.preventDefault();else{if(this.singlePageView){if(!this.arabicStyle&&pageIndex===this.totalItemPages-1)return void event.preventDefault();if(this.arabicStyle&&0===pageIndex)return void event.preventDefault()}clearTimeout(this.renderCustomContentTimeout),this.renderCustomContentTimeout=setTimeout($.proxy(this,"renderCustomContent",pageIndex),100),this.closeForm(),this.playFlipSound()}else event.preventDefault()},handleTurned:function(event,pageIndex){var previewPages,range,loadedPages,self;this.closeForm(),this.trigger(WidgetEvent.PAGE_TURN_END,{currentPageIndex:pageIndex}),this.trigger(WidgetEvent.PAGE_CHANGED,pageIndex),this.stopCustomContent(),this.startCustomContent(pageIndex),this.showPdfLinks(pageIndex),this.checkFormAndShowIt(pageIndex),FSWidgetModel.gi().get("isForSelling")&&FSWidgetModel.gi().get("sellSettingsPage")&&(self=this,previewPages=this.arabicStyle?FSWidgetModel.gi().get("sell").previewPages.map(function(pageNumber){return self.flipTotalPages-pageNumber+1}):FSWidgetModel.gi().get("sell").previewPages,range=this.getRange(),(loadedPages=_.range(range[0],range[1]+1,1)).forEach(function(pageNumber){var pageIdx=pageNumber-1,pageContainer=self.getPageContainer(pageNumber),pageInList=self.model.get("item").get("pages").at(pageIndex),imgSource=pageContainer.find("img.page-image").attr("src"),pageHasThumbLoaded=!!imgSource&&imgSource.indexOf("/thumb?")>0,pageIsBlocked=pageInList.get("isBlockedForSellingPreview");0!==pageContainer.length&&pageIsBlocked!==pageHasThumbLoaded&&(previewPages.indexOf(pageNumber)>-1&&pageContainer.hasClass("locked")&&!pageIsBlocked?loadedPages.indexOf(pageNumber)&&(pageContainer.find(".image-container .page-image").off(),pageContainer.find(".image-container").empty(),pageContainer.find(".fsw-wheelpreloader").empty().remove(),self.loadPage(pageIdx,pageContainer)):-1===previewPages.indexOf(pageNumber)&&!pageContainer.hasClass("locked")&&pageIsBlocked&&(pageContainer.find(".image-container .page-image").off(),pageContainer.find(".image-container").empty(),pageContainer.find(".fsw-wheelpreloader").empty().remove(),self.stopCustomContentOnPage(pageIdx),self.customContent[pageIdx]&&(self.customContent[pageIdx].remove(),self.customContent[pageIdx].empty(),self.customContent[pageIdx]=null,delete self.customContent[pageIdx]),pageContainer.find(".custom-content-container").empty(),self.loadPage(pageIdx,pageContainer)))}))},checkFormAndShowIt:function(pageIndex){0===pageIndex||pageIndex===this.totalItemPages-1?(formData=this.getPageForm(pageIndex),formData&&this.showForm(pageIndex,formData.form)):this.arabicStyle?(pageIndex=this.isLeftPage(pageIndex)?pageIndex+1:pageIndex,formData=this.getPageForm(pageIndex),formData?this.showForm(pageIndex,formData.form):(formData=this.getPageForm(pageIndex-1),formData&&this.showForm(pageIndex-1,formData.form))):(pageIndex=this.isLeftPage(pageIndex)?pageIndex:pageIndex-1,formData=this.getPageForm(pageIndex),formData?this.showForm(pageIndex,formData.form):(formData=this.getPageForm(pageIndex+1),formData&&this.showForm(pageIndex+1,formData.form)))},handleMissing:function(event,pages){var i;for(i=0;i<pages.length;i++)this.addPage(pages[i]-1,this.flipbook)},pageHasForm:function(pageIndex){var obj;return!FSWidgetModel.gi().get("isDownload")&&(void 0!==(obj=this.getPageForm(pageIndex))&&null!==obj)},pageHasBlockingForm:function(pageIndex){var obj=this.getPageForm(pageIndex);return void 0!==obj&&null!==obj&&obj.form&&obj.form.limit===LeadFormBlocking.ALL},getPageForm:function(pageIndex){var itemForms=FSWidgetModel.gi().widgetState.get("currentItem")&&FSWidgetModel.gi().widgetState.get("currentItem").get("forms"),currentPageIndex=this.getSinglePageIndex(pageIndex);if(!(currentPageIndex<-1||FSWidgetModel.gi().widgetSettings.get("exportVideo")))return _.find(itemForms,function(formData){return formData.index===currentPageIndex})},getPageContainer:function(pageIndex){return this.flipbook.find(".p"+pageIndex+" .page-content")},getSinglePageIndex:function(pageIndex){var currentPageIndex=pageIndex,paginaPara=pageIndex%2==0;if(this.singlePageView)if(this.arabicStyle){if(paginaPara)return-1;currentPageIndex=(pageIndex-1)/2}else{if(!paginaPara)return-1;currentPageIndex=pageIndex/2}return currentPageIndex},showForm:function(pageIndex,formData){var pageContainer;FSWidgetModel.gi().get("isDownload")||(pageContainer=this.getPageContainer(pageIndex+1),LeadFormView.gi({model:new LeadFormModel({eID:formData.eID,pid:this.model.get("item").get("pages").at(pageIndex).get("pID"),limit:formData.limit,header:formData.header,placeholder:formData.placeholder,bookIndex:this.model.get("item").get("itemIndex"),pageIndex:this.model.get("item").get("pages").at(pageIndex).get("pageIndex"),realPageNumber:this.model.get("item").get("pages").at(pageIndex).get("pageIndexInBook"),bookTitle:this.model.get("item").get("title"),elements:formData.elements,pageSize:[this.pageWidth,this.pageHeight],pageContainer:pageContainer,widgetContainer:$(ComponentContainers.MAIN_LAYOUT),labels:{buttonLabel:formData.label,requiredFieldLabel:"required fields",fieldRequiredLabel:"This field is required.",validEmailLabel:"Please enter a valid email address."},formVersion:formData.formVersion})}))},closeForm:function(formData){var pageNumber,pageIndex,pageContainer,leftPageIndex,rightPageIndex,leftPageContainer,rightPageContainer;LeadFormView.close(),formData&&"number"==typeof formData.pageIndex&&(pageNumber=formData.pageIndex+1,pageIndex=formData.pageIndex,this.singlePageView&&(this.arabicStyle?pageIndex=2*pageIndex+1:pageIndex*=2,pageNumber=pageIndex+1),pageContainer=this.getPageContainer(pageNumber),this.loadPage(pageIndex,pageContainer),this.arabicStyle?(leftPageIndex=pageIndex-1,!this.isLeftPage(pageIndex)&&leftPageIndex>-1&&(this.pageHasForm(leftPageIndex)?this.showForm(leftPageIndex,this.getPageForm(leftPageIndex).form):formData.limit===LeadFormBlocking.ALL&&(leftPageContainer=this.getPageContainer(pageIndex),this.loadPage(leftPageIndex,leftPageContainer)))):(rightPageIndex=pageIndex+1,this.isLeftPage(pageIndex)&&rightPageIndex<this.totalItemPages&&(this.pageHasForm(rightPageIndex)?this.showForm(rightPageIndex,this.getPageForm(rightPageIndex).form):formData.limit===LeadFormBlocking.ALL&&(rightPageContainer=this.getPageContainer(pageNumber+1),this.loadPage(rightPageIndex,rightPageContainer)))),this.startCustomContent(pageIndex))},getPageBlockedCorners:function(pageIndex){var leftPageCorners=["tl","bl","l"],rightPageCorners=["tr","br","r"];return this.pageHasBlockingForm(pageIndex)?this.arabicStyle?leftPageCorners:rightPageCorners:this.arabicStyle?this.getCornersIfBlocked(pageIndex,leftPageCorners):this.getCornersIfBlocked(pageIndex,rightPageCorners)},getCornersIfBlocked:function(pageIndex,pageCorners){var corners=null;return(this.isLeftPage(pageIndex)&&this.pageHasBlockingForm(pageIndex+1)||!this.isLeftPage(pageIndex)&&this.pageHasBlockingForm(pageIndex-1))&&(corners=pageCorners),corners},getIfNextNavIsBlocked:function(isArabicStyle,currentLeftPage,nextLeftPage){var direction=nextLeftPage-currentLeftPage,ret=!1;return(isArabicStyle&&direction<0||!isArabicStyle&&direction>0)&&(ret=this.isPageTurnBlocked(currentLeftPage-1)),ret},isPageTurnBlocked:function(currentPageIndex){var currentLeftPageIndex=this.isLeftPage(currentPageIndex)?currentPageIndex:currentPageIndex-1,currentRightPageIndex=currentLeftPageIndex+1;return this.pageHasBlockingForm(currentLeftPageIndex)||this.pageHasBlockingForm(currentRightPageIndex)},destroyFlippingBookView:function(){this.$el.find(".page-content img.page-image").each(function(){$(this).off().remove()}),this.flipbook.turn("destroy"),$(".fsw-embedmsg-container").remove(),this.destroyCustomContent()},destroyCustomContent:function(){var i;if(this.customContent){for(i in this.customContent)this.customContent.hasOwnProperty(i)&&(this.customContent[i].remove(),delete this.customContent[i]);this.customContent={}}},addPage:function(pageIndex,book){var element=$("<div />",{}),item=this.model.get("item"),pageIdx=pageIndex;item.get("hardCover")&&this.setHardCover(pageIdx,element,item),book.turn("addPage",element,pageIdx+1)&&(pageIdx%2==0?element.html(FlipTemplates.rightPageContainer):element.html(FlipTemplates.leftPageContainer),this.model.get("showPageShadows")||element.find(".gradient").hide(),this.canLoadContent(pageIdx)&&this.loadPage(pageIdx,element.find(".page-content")))},setHardCover:function(pageIndex,element,item){[0,1,item.get("noOfPages")-2,item.get("noOfPages")-1].indexOf(pageIndex)>-1&&(element.addClass("hard"),0===pageIndex||pageIndex===item.get("noOfPages")-1?element.addClass("outer"):element.addClass("inner"))},canLoadContent:function(pageIndex){var case1=this.arabicStyle&&this.isLeftPage(pageIndex)&&pageIndex+1<this.totalItemPages-1&&this.pageHasBlockingForm(pageIndex+1),case2=!this.arabicStyle&&!this.isLeftPage(pageIndex)&&pageIndex-1>0&&this.pageHasBlockingForm(pageIndex-1),case3=this.pageHasForm(pageIndex);return!case1&&!case2&&!case3},loadPage:function(pageIndex,pageElement){var page=this.model.get("item").get("pages").at(pageIndex);page.get("isBlockedForSellingPreview")?(pageElement.addClass("locked"),this.loadThumbPage(pageIndex,pageElement,!0)):(pageElement.removeClass("locked"),this.setBackgroundColor(page.get("bgColor"),pageElement),this.loadImageContent(pageIndex,pageElement,!0),page.get("type")===PageType.CUSTOM_PAGE&&this.loadCustomContent(pageIndex,pageElement))},loadImageContent:function(pageIndex,pageElement,showPreloader){if(this.model.get("item").get("pages").at(pageIndex).get(ImageTypes.ORIGINAL))switch(this.isInFullScreen=FSUtils.isInFullScreen(),this.isInFullScreen||this.currentZoom>0?ImageTypes.ORIGINAL:FSUtils.getImageSizeType(this.pageWidth,this.pageHeight)){case ImageTypes.THUMB:case ImageTypes.SMALL:this.loadSmallPage(pageIndex,pageElement,showPreloader);break;case ImageTypes.MEDIUM:this.loadMediumPage(pageIndex,pageElement,showPreloader);break;default:this.loadOriginalPage(pageIndex,pageElement,showPreloader)}},loadCustomContent:function(pageIndex,pageElement){this.hasCustomContent(pageIndex)&&this.addCustomContent(pageIndex,pageElement.find(".custom-content-container"))},hasCustomContent:function(pageIndex){var customElements;return pageIndex>=this.totalItemPages?null:(customElements=(customElements=this.model.get("item").get("pages").at(pageIndex).get("customElements")||[]).filter(function(element){return element&&"number"==typeof element.type&&"number"==typeof element.action&&element.type!==ElementType.FORM}))&&customElements.length>0},loadThumbPage:function(pageIndex,pageElement,showPreloader){this.loadImage(pageIndex,pageElement,ImageTypes.THUMB,showPreloader)},loadSmallPage:function(pageIndex,pageElement,showPreloader){this.loadImage(pageIndex,pageElement,ImageTypes.SMALL,showPreloader)},loadMediumPage:function(pageIndex,pageElement,showPreloader){this.loadImage(pageIndex,pageElement,ImageTypes.MEDIUM,showPreloader)},loadOriginalPage:function(pageIndex,pageElement,showPreloader){this.loadImage(pageIndex,pageElement,ImageTypes.ORIGINAL,showPreloader)},loadImage:function(pageIndex,pageElement,imageType,showPreloader){var img,imgUrl,preloader,container=pageElement.find(".image-container"),prevImg=container.find("img"),self=this,retryFirstImage=!1,page=this.model.get("item").get("pages").at(pageIndex);prevImg.attr("data-type")!==imageType&&(img=$('<img class="page-image" data-type="'+imageType+'" />').mousedown(function(event){event.preventDefault()}).one("load",function(){var imgInContainer=container.find("img");if(image=$(this),imgInContainer.length){container.find("img").off().remove(),image.attr({"data-width":this.width,"data-height":this.height,"data-page":pageIndex+1});var scale=self.currentZoom+1;self.scaleImage(self.pageWidth*scale,self.pageHeight*scale,this),image.appendTo(container),pageElement.find(".fsw-wheelpreloader").empty().remove(),page.get("isBlockedForSellingPreview")||(self.loadCustomContent(pageIndex,pageElement),pageIndex===self.model.get("currentPageIndex")&&self.startCustomContent(pageIndex),self.showPdfLinks(pageIndex))}image.off(),img.off(),img=null,imgInContainer=null,prevImg=null}).one("error",function(){(retryFirstImage=0===pageIndex&&self.model.get("retryFirstImage")&&self.firstImageRetries>0)&&self.firstImageRetries--,($(this).attr("data-type")!==ImageTypes.ORIGINAL||retryFirstImage)&&setTimeout(function(){self.loadOriginalPage(pageIndex,pageElement,ImageTypes.ORIGINAL,!0)},retryFirstImage?2e3:0),pageElement.find(".fsw-wheelpreloader").empty().remove(),img.off(),img=null,container=null,prevImg=null}),showPreloader&&(preloader=new WheelPreloader(40),pageElement.append($("<div/>").addClass("fsw-wheelpreloader").append(preloader.render().$el))),imgUrl=this.model.get("item").get("pages").at(pageIndex).get(imageType),img.appendTo(container),img.attr("src",imgUrl))},appendImage:function(pageElement,image,container){pageElement.find(".fsw-wheelpreloader").empty().remove(),image.appendTo(container),image=null,container=null},scaleImage:function(w,h,img){var $img=$(img),ow=$img.attr("data-width"),oh=$img.attr("data-height"),newSize=FSUtils.calculatePageSize(w,h,ow,oh,Math.ceil);$img.width()===newSize.width&&$img.height()===newSize.height||$(img).css({position:"absolute",width:newSize.width+"px",height:newSize.height+"px",left:Math.ceil((w-newSize.width)/2)+"px",top:Math.ceil((h-newSize.height)/2)+"px"})},getImageSize:function(pageIndex){var pageImage=this.getPageContainer(pageIndex+1).find("img.page-image");return pageImage.length?{w:pageImage.width(),h:pageImage.height()}:{w:this.pageWidth,h:this.pageHeight}},countImageElements:function(elements){var i,count=0;for(i=0;i<elements.length;i++)elements[i].type===ElementType.IMAGE&&count++;return count},getPageCustomContentModel:function(page,zoom){var pageModel=this.model.get("item").get("pages").at(page),customElements=pageModel.get("customElements"),imageElements=this.countImageElements(customElements);return{pageModel:pageModel,elements:customElements,page:page,scale:this.getScale(page),oldEditorScaling:FSUtils.getOldEditorScaling(pageModel.get("height"),pageModel.get("width"),EDITOR_DEFAULTS),firstPageWidth:this.firstPageWidth,firstPageHeight:this.firstPageHeight,pageWidth:this.pageWidth,pageHeight:this.pageHeight,status:ContentLoaderStatus.IDLE,imageElements:imageElements,widgetZoom:zoom||1}},addCustomContent:function(page,pageElement){var preloader=new WheelPreloader(40),customContentModel=this.getPageCustomContentModel(page,this.currentZoom+1);if(this.isDoublePageLayout&&page>0&&(this.flipTotalPages%2!=0||page!==this.flipTotalPages-1))if(page%2!=0){this.model.get("item").get("pages").at(page+1)&&(customContentModel.rightPageModel=this.getPageCustomContentModel(page+1,this.currentZoom+1))}else{this.model.get("item").get("pages").at(page-1)&&(customContentModel.leftPageModel=this.getPageCustomContentModel(page-1,this.currentZoom+1))}this.customContent[page]?this.customContent[page].model.set(customContentModel):(this.customContent[page]=new CustomContentView({model:new Backbone.Model(customContentModel)}),this.customContent[page].render(),0===customContentModel.imageElements?pageElement.append(this.customContent[page].$el):(pageElement.append($("<div/>").addClass("fsw-wheelpreloader").append(preloader.render().$el)),this.listenTo(this.customContent[page].model,"change:status",function(){pageElement.append(this.customContent[page].$el),pageElement.find(".fsw-wheelpreloader").empty().remove()}))),this.model.get("currentPageIndex")===page-1&&this.startCustomContent(page-1)},renderCustomContent:function(pageIndex){this.renderContent(pageIndex,this.getPageContainer(pageIndex+1)),this.isLeftPage(pageIndex)||0===pageIndex||this.renderContent(pageIndex-1,this.getPageContainer(pageIndex)),this.isLeftPage(pageIndex)&&pageIndex<this.totalItemPages-1&&this.renderContent(pageIndex+1,this.getPageContainer(pageIndex+2))},renderContent:function(pageIndex,pageContainer){!this.pageHasForm(pageIndex)&&this.customContent[pageIndex]&&pageContainer&&this.customContent[pageIndex].start("turning")},handleShelfOpened:function(){this.stopCurrentCustomContent(),LeadFormView.close()},handleShelfClosed:function(){var pageIndex=FSWidgetModel.gi().widgetState.get("currentPageIndex");LeadFormView.close(),this.startCustomContent(pageIndex),this.checkFormAndShowIt(pageIndex)},startCustomContent:function(pageIndex){this.startContent(pageIndex,this.getPageContainer(pageIndex+1)),this.isLeftPage(pageIndex)||0===pageIndex||this.startContent(pageIndex-1,this.getPageContainer(pageIndex)),this.isLeftPage(pageIndex)&&pageIndex<this.totalItemPages-1&&this.startContent(pageIndex+1,this.getPageContainer(pageIndex+2))},startContent:function(pageIndex,pageContainer){!this.pageHasForm(pageIndex)&&this.customContent[pageIndex]&&pageContainer&&this.customContent[pageIndex].start("end")},startCurrentCustomContent:function(){this.startCustomContent(this.model.get("currentPageIndex"))},stopCurrentCustomContent:function(){this.stopCustomContentOnPage(this.model.get("currentPageIndex"))},stopCustomContent:function(){for(var pageIndex,i=0,len=this.pagesToStopCustomContentOn.length;i<len;i+=1)pageIndex=this.pagesToStopCustomContentOn[i],this.model.get("currentPageIndex")!==pageIndex&&this.stopCustomContentOnPage(pageIndex)},stopCustomContentOnPage:function(pageIndex){var adjacentIndex;this.customContent[pageIndex]&&this.customContent[pageIndex].stop(),adjacentIndex=-1,this.isLeftPage(pageIndex)?pageIndex+1<=this.totalItemPages-1&&this.customContent[pageIndex+1]&&(adjacentIndex=pageIndex+1):pageIndex-1>0&&this.customContent[pageIndex-1]&&(adjacentIndex=pageIndex-1),adjacentIndex>-1&&this.model.get("currentPageIndex")!==adjacentIndex&&this.customContent[adjacentIndex].stop()},loadFonts:function(){var customElements,i,j;for(i=0;i<this.totalItemPages;i++)if(customElements=this.model.get("item").get("pages").at(i).get("customElements"))for(j=0;j<customElements.length;j++)customElements[j].fontFamily&&customElements[j].fontFamily.length>0&&FontManager.gi().addFont(customElements[j].fontFamily),customElements[j].type!==ElementType.PAYPAL&&customElements[j].type!==ElementType.PAYPAL_TOOLTIP||FontManager.gi().addFont("Open Sans");FontManager.gi().loadFonts()},calculatePageSize:function(){this.oldCalculatePageSize()},positionFlip:function(){this.oldPositionFlip()},resizePageContents:function(){this.oldResizePageContents()},getScale:function(pageIndex){var pageSize,numPageIndex=parseInt(pageIndex,10),pageModel=this.model.get("item").get("pages").at(numPageIndex),imageSize_w=this.pageWidth,imageSize_h=this.pageHeight,pageWidth=imageSize_w*(this.currentZoom+1),pageHeight=imageSize_h*(this.currentZoom+1);return pageModel?(pageSize=FSUtils.calculateScaledSize(pageModel.get("width"),pageModel.get("height"),EDITOR_DEFAULTS.width,EDITOR_DEFAULTS.height),1/FSUtils.calculateScale(pageSize.width,pageSize.height,pageWidth,pageHeight,!0)):1},getPageScale:function(pageIndex){return this.oldGetPageScale(pageIndex)},pageChanged:function(){this.pagesToStopCustomContentOn.push(this.model.get("lastPageIndex")),this.flipbook.turn("page",this.model.get("currentPageIndex")+1)},isLeftPage:function(pageIndex){return pageIndex%2!=0},isWidgetZoomed:function(){return 1!==FSUtils.getZoomLevel()},getTargetPage:function($targetElement){var $elementParent=$targetElement.parent();return $elementParent.hasClass("page")?$elementParent.hasClass("right")?DocumentView.PAGE_RIGHT:DocumentView.PAGE_LEFT:0},remove:function(){LeadFormView.hasInstance()&&(LeadFormView.gi().remove(),LeadFormView.gi().model.destroy(),LeadFormView._instance=null),this.destroySound(),this.removePdfLinks(),this.flipbook.turn&&this.flipbook.turn("pages")>0&&this.destroyFlippingBookView(),Backbone.Mediator.unsubscribe(WidgetEvent.LEAD_FORM_SENT,this.closeForm,this),Backbone.Mediator.unsubscribe(WidgetEvent.PDF_LINKS_LOADED,this.pdfLinksLoaded,this),Backbone.Mediator.unsubscribe(WidgetEvent.MUTE,this.muteFlipSound,this),Backbone.Mediator.unsubscribe(WidgetEvent.UN_MUTE,this.unmuteFlipSound,this),Backbone.Mediator.unsubscribe(ShelfEvents.SHELF_OPENED,this.handleShelfOpened,this),Backbone.Mediator.unsubscribe(ShelfEvents.SHELF_CLOSED,this.startCurrentCustomContent,this),Backbone.Mediator.unsubscribe(WidgetEvent.ZOOM_CHANGED,this.oldDesktopHandleZoomChanged,this),Backbone.Mediator.unsubscribe(WidgetEvent.ZOOM_END,this.oldDesktopHandleZoomEnd,this),Backbone.Mediator.unsubscribe(NewShelfEvents.CLOSE_ITEM,this.destroyFlippingBookView,this),$(document.body).off(),this.flipbook.off(),Backbone.View.prototype.remove.apply(this,arguments)},mouseOverPage:function(e){Backbone.Mediator.pub(WidgetEvent.MOUSE_OVER_PAGE,e.currentTarget.attributes.page.value)},mouseOutPage:function(e){Backbone.Mediator.pub(WidgetEvent.MOUSE_OUT_PAGE,e.currentTarget.attributes.page.value)},mouseEnterView:function(e){"docView"!==(e?$(e.target).attr("id"):void 0)&&this.model.get("displayType")!==DisplayType.SMALL&&(e&&$(e.target).hasClass("nav-button")||e&&this.mouseMoveDocView(e))},mouseMoveDocView:function(e){this.oldMouseMoveDocView(e)},mouseDownDocView:function(e){FSUtils.isMobileDevice()||"IMG"!==e.target.tagName&&"image"!==e.target.tagName||e.preventDefault(),this.flipbook.addClass("mousedown"),this.startTranslatePos=FSUtils.getElementCSSTransform(this.viewLimiter[0]),this.startMouseX=e.pageX,this.startMouseY=e.pageY},mouseUpDocView:function(){this.flipbook.hasClass("mousedown")&&this.currentZoom>0&&(this.deltaX||this.deltaY)&&(this.deltaX=this.deltaX||0,this.deltaY=this.deltaY||0,this.deltaX=Math.max(this.xmin,Math.min(this.xmax,this.deltaX)),this.deltaY=Math.max(this.ymin,Math.min(this.ymax,this.deltaY)),this.viewLimiter.css({transition:"transform 0.2s",transform:"translate3d("+this.deltaX+"px, "+this.deltaY+"px, 0) scale(1)"})),this.flipbook.removeClass("mousedown")},enterZoom:function(ev){var pageX=this.isMobileDevice?ev.originalEvent.changedTouches[0].clientX:ev.pageX,pageY=this.isMobileDevice?ev.originalEvent.changedTouches[0].clientY:ev.pageY;this.model.get("displayType")===DisplayType.SMALL||$(ev.target).hasClass("nav-button")||(0===this.currentZoom?(this.xZoom=pageX-this.documentViewObj.viewLimiter.left,this.yZoom=pageY-this.documentViewObj.viewLimiter.top,Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:FSWidgetModel.gi().get("maxZoomValue")})):(this.deltaX=this.deltaY=this.xmin=this.ymin=this.xmax=this.ymax=void 0,Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:0})))},handleMouseWheel:function(e){var maxZoomValue,newZoomValue,direction;this.currentZoom>0&&(direction=e.deltaY>0?1:-1,maxZoomValue=FSWidgetModel.gi().get("maxZoomValue"),newZoomValue=this.currentZoom+direction*maxZoomValue*DEFAULT_ZOOM_STEP/100,newZoomValue=Math.max(0,Math.min(maxZoomValue,newZoomValue)),this.xZoom=this.yZoom=void 0,Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:newZoomValue}))},mouseOutBody:function(){this.getPageContainer(this.model.get("currentPageIndex")+1).mouseup()},mouseUpBody:function(){this.flipbook.hasClass("mousedown")&&this.mouseUpDocView()},disableRightClick:function(){location.host.indexOf("site.flipsnack.net")>-1||location.host.indexOf("flipsnack.io")>-1||"widget"===location.host||"widgetjs"===location.host||document.addEventListener("contextmenu",function(e){e.preventDefault()})},calculateTranslation:function(){var divider,transformMatrixValues,tx,ty,xmin,xmax,ymin,ymax,isOnePage=this.singlePageView||0===this.model.get("currentPageIndex")||this.model.get("currentPageIndex")===this.totalItemPages-1;return transformMatrixValues=FSUtils.getElementCSSTransform(this.viewLimiter[0]),tx=0===this.currentZoom?0:transformMatrixValues.x,ty=0===this.currentZoom?0:transformMatrixValues.y,divider=isOnePage?4:2,divider=this.singlePageView?2:divider,xmin=-(xmax=this.documentViewObj.viewLimiter.width/divider*this.currentZoom),ymin=-(ymax=this.documentViewObj.flipbook.height/2*this.currentZoom),this.xZoom&&this.yZoom&&(tx=this.xZoom<=$(window).width()/2?(this.documentViewObj.viewLimiter.width/2-this.xZoom)*this.currentZoom:(this.documentViewObj.viewLimiter.width/2-(this.documentViewObj.viewLimiter.width-this.xZoom))*-this.currentZoom,ty=this.yZoom<=$(window).height()/2?(65+this.documentViewObj.flipbook.height/2-this.yZoom)*this.currentZoom:(this.documentViewObj.flipbook.height/2-(65+this.documentViewObj.flipbook.height-this.yZoom))*-this.currentZoom,this.xZoom=this.yZoom=void 0),{tx:tx=Math.max(Math.min(tx,xmax),xmin),ty:ty=Math.max(Math.min(ty,ymax),ymin)}},oldDesktopHandleZoomChanged:function(obj){var translateValues,tx,ty;this.currentZoom=obj.value,tx=0===(translateValues=this.calculateTranslation()).tx?0:translateValues.tx+"px",ty=0===translateValues.ty?0:translateValues.ty+"px",this.resize(!0),this.viewLimiter.css({transition:"none",transform:"perspective(1px) translate3d("+tx+", "+ty+", 0) scale(1)"})},oldDesktopHandleZoomEnd:function(){var translateValues,tx,ty;"string"==typeof FSWidgetModel.gi().get("collectionData").trackingId&&FSWidgetModel.gi().get("collectionData").trackingId.length&&!FlipSnackEmbed.isEditor&&Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Zoom"),0===this.currentZoom&&(this.flipbookBoundsRect=this.flipbook[0].getBoundingClientRect(),this.viewLimiterBoundsRect=this.viewLimiter[0].getBoundingClientRect()),this.currentZoom>0&&(this.deltaX=0,this.deltaY=0),tx=0===(translateValues=this.calculateTranslation()).tx?0:translateValues.tx+"px",ty=0===translateValues.ty?0:translateValues.ty+"px",this.resize(!1),this.viewLimiter.css({transition:"none",transform:"perspective(1px) translate3d("+tx+", "+ty+", 0) scale(1)"}),this.currentZoom>0?this.flipbook.addClass("zoomed"):this.flipbook.removeClass("zoomed")},oldResize:function(){this.model.get("displayType")===DisplayType.SMALL?this.model.get("collectionSize")[0]<FlipView.SMALL_MAX_WIDTH||this.model.get("collectionSize")[1]<FlipView.SMALL_MAX_HEIGHT?this.$el.removeClass("large").addClass("small"):this.$el.removeClass("small").addClass("large"):this.$el.removeClass("small large"),"boolean"==typeof pageSizes&&pageSizes||(this.calculatePageSize(),LeadFormView.hasInstance()&&LeadFormView.gi().model.set("pageSize",[this.pageWidth,this.pageHeight]),this.setCustomContentPageSize()),this.positionFlip()},oldCalculatePageSize:function(){var scaleRatio,currentItemPages=this.model.get("item").get("pages"),firstPage=this.arabicStyle?currentItemPages.at(this.totalItemPages-1):currentItemPages.at(0),maxPageWidth=this.singlePageView?this.model.get("maxSize")[0]:Math.floor(this.model.get("maxSize")[0]/2),maxPageHeight=this.model.get("maxSize")[1];this.firstPageWidth=firstPage.get("width"),this.firstPageHeight=firstPage.get("height"),this.pageWidth=Math.min(maxPageWidth,this.firstPageWidth),this.pageHeight=Math.min(maxPageHeight,this.firstPageHeight),this.pageWidth/this.pageHeight!==this.firstPageWidth/this.firstPageHeight&&(scaleRatio=Math.max(this.firstPageWidth/maxPageWidth,this.firstPageHeight/maxPageHeight),this.pageWidth=Math.ceil(this.firstPageWidth/scaleRatio),this.pageHeight=Math.ceil(this.firstPageHeight/scaleRatio))},oldPositionFlip:function(){var left,self=this,scale=this.currentZoom+1,w=2*this.pageWidth*scale,h=this.pageHeight*scale,mw=this.model.get("maxSize")[0],mh=this.model.get("maxSize")[1],offset=this.model.get("offset"),l=Math.round((mw-w)/2)+offset.left,t=Math.round((mh-h)/2)+offset.top,navButtonWidth=this.model.get("navButtonWidth"),vlWidth=this.singlePageView?this.pageWidth*scale:w,vlHeight=h+offset.top,widgetHeight=FSWidgetModel.gi().get("height");this.flipbook.css({left:this.arabicStyle?0:vlWidth-w+"px",top:this.currentZoom>0?0:t+"px",width:w+"px",height:h+"px"}),left=Math.ceil((mw+2*navButtonWidth-vlWidth)/2)+offset.left,this.viewLimiter.css({left:left+"px",top:0===this.currentZoom?0:t+"px",width:vlWidth+"px",height:Math.max(vlHeight,widgetHeight)+"px"}),this.documentViewObj.viewLimiter={left:left,top:0===this.currentZoom?0:t,width:vlWidth,height:Math.max(vlHeight,widgetHeight)},this.documentViewObj.flipbook={left:this.arabicStyle?0:vlWidth-w,top:this.currentZoom>0?0:t,width:w,height:h},this.docContainer.css({left:-offset.left+"px",top:-offset.top+"px",width:$(window).width()+"px",height:$(window).height()+"px"}),this.flipbook.turn("size",w,h),this.flipbook.turn("resize"),this.resizePageContents(),this.trigger(FlipEvents.FLIP_POSITIONED,{top:t,left:l,width:vlWidth,height:h}),0===this.currentZoom&&setTimeout(function(){self.flipbookBoundsRect=self.flipbook[0].getBoundingClientRect(),self.viewLimiterBoundsRect=self.viewLimiter[0].getBoundingClientRect()},10)},oldResizePageContents:function(){var self=this,imageList=this.flipbook.find("img.page-image").toArray(),scale=this.currentZoom+1;_.each(imageList,function(elem){var $elem=$(elem),pageIdx=parseInt($elem.data("page")-1,10),imageContainer=$elem.parents(".page-content"),page=self.model.get("item").get("pages").at(pageIdx);self.scaleImage(self.pageWidth*scale,self.pageHeight*scale,elem),page&&!page.get("isBlockedForSellingPreview")&&self.loadImageContent(pageIdx,imageContainer,!1),self.resizePdfLinksContainer(pageIdx,!0)}),_.each(this.customContent,function(elem,pageIndex){var page=parseInt(pageIndex,10);if(self.isDoublePageLayout&&page>0&&(self.flipTotalPages%2!=0||page!==self.flipTotalPages-1))if(page%2!=0){self.model.get("item").get("pages").at(page+1)&&elem.model.set("rightPageModel",self.getPageCustomContentModel(page+1,scale))}else{self.model.get("item").get("pages").at(page-1)&&elem.model.set("leftPageModel",self.getPageCustomContentModel(page-1,scale))}elem.resize(self.getScale(page))})},oldMouseMoveDocView:function(e){var currentLeft,currentTop,currentRight,currentBottom;$(e.target).attr("id");if(this.currentZoom>0&&this.flipbook.hasClass("mousedown"))return currentLeft=parseInt(this.viewLimiter.css("left"),10)+parseInt(this.viewLimiter.css("margin-left"),10),currentTop=parseInt(this.viewLimiter.css("top"),10)+parseInt(this.viewLimiter.css("margin-top"),10),currentRight=Math.round(this.viewLimiter.width())+currentLeft,currentBottom=Math.round(this.viewLimiter.height())+currentTop,this.deltaX=e.pageX-this.startMouseX+this.startTranslatePos.x,this.xmax=this.viewLimiterBoundsRect.left-currentLeft,this.xmin=this.viewLimiterBoundsRect.right-currentRight,this.deltaY=e.pageY-this.startMouseY+this.startTranslatePos.y,this.ymax=this.flipbookBoundsRect.top-currentTop,this.ymin=this.flipbookBoundsRect.bottom+this.flipbookBoundsRect.top-currentBottom,void this.viewLimiter.css({transition:"none",transform:"translate3d("+this.deltaX+"px, "+this.deltaY+"px, 0px) scale(1)"});e.mousePositionY=e.clientY+this.$el.position().top},oldSetCustomContentPageSize:function(){var i;if(this.customContent)for(i in this.customContent)this.customContent.hasOwnProperty(i)&&this.customContent[i].model.set({pageWidth:this.pageWidth*(this.currentZoom+1),pageHeight:this.pageHeight*(this.currentZoom+1)})},oldGetPageScale:function(pageIndex){var size,pageModel=this.model.get("item").get("pages").at(parseInt(pageIndex,10));return pageModel?(size=FSUtils.calculatePageSize(this.pageWidth*(this.currentZoom+1),this.pageHeight*(this.currentZoom+1),pageModel.get("width"),pageModel.get("height"),Math.ceil),pageModel.get("height")>pageModel.get("width")?size.height/pageModel.get("height"):size.width/pageModel.get("width")):1},updatePreviewPages:function(changes){var pageContainer,pageIndex,self=this,changedPages=this.arabicStyle?changes.map(function(pageNum){return self.flipTotalPages-pageNum+1}):changes,turnRange=this.getRange(),loadedPages=_.range(turnRange[0],turnRange[1]+1,1),updatedPages=_.intersection(loadedPages,changedPages);updatedPages.length&&updatedPages.forEach(function(pageNumber){pageContainer=self.getPageContainer(pageNumber),pageIndex=pageNumber-1,pageContainer.find(".image-container img.page-image").off(),pageContainer.find(".image-container").empty(),pageContainer.find(".fsw-wheelpreloader").empty().remove(),self.stopCustomContentOnPage(pageIndex),self.customContent[pageIndex]&&(self.customContent[pageIndex].remove(),self.customContent[pageIndex].empty(),self.customContent[pageIndex]=null,delete self.customContent[pageIndex]),pageContainer.find(".custom-content-container").empty(),self.loadPage(pageIndex,pageContainer)})},getRange:function(){var pages=this.flipbook.find(".page-wrapper"),range=[];return pages.length>0?(_.each(pages,function(page){var pageNumber=isNaN(page.getAttribute("page"))?-1:parseInt(page.getAttribute("page"),10);pageNumber>=0&&range.push(pageNumber)}),range.length>0?(range.sort(function(a,b){return a-b}),[range[0],range[range.length-1]]):[]):[]},setBackgroundColor:function(color,element){""!==color&&element.css({backgroundColor:color})}});DocumentView.DOUBLE_TAP_RADIUS=30,DocumentView.DOUBLE_TAP_TIMEOUT=300,DocumentView.MAX_ZOOM_VALUE=5,function(global){var context=this;function callCreateWhenCustomViewLoaded(){FlipView.gi()}window.FlipView=Backbone.View.extend({el:ComponentContainers.FLIP_VIEW,initialize:function(){this.isPlayerSkin=FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.PLAYER,this.isSinglePageView=FSWidgetModel.gi().widgetSettings.get("singlePageView"),this.isArabicStyle=FSWidgetModel.gi().widgetSettings.get("arabicStyle"),this.totalItems=FSWidgetModel.gi().flipCollection.get("noOfItems"),this.itemNavigationVisible=FSWidgetModel.gi().widgetState.get("displayType")===DisplayType.SMALL&&this.totalItems>1,this.docViewHeight=0,this.docPageIndex=this.calculatePageIndexForLocal(FSWidgetModel.gi().widgetState.get("currentPageIndex")),this.touchStartPosX=0,this.deltaX=0,this.currentTouchPosX=0,this.isMobileDevice=FSUtils.isMobileDevice(),this.isIOS=FSUtils.isIOS(),this.flipTotalPages=FSWidgetModel.gi().flipCollection.totalPages,this.isInFullScreen=FSUtils.isInFullScreen(),this.timeout=null,this.firstTouchPos=null,this.lastTap=0,this.startZoom=1,this.flipViewContainer=this.$el.parent().find(ComponentContainers.FLIP_VIEW),this.processCurrentItem(),this.createPageNavigation(),this.createItemNavigation(),this.createDocumentView(),this.createGenericElementsContainer(),this.itemNavigationVisible?this.itemNavigation.show():this.itemNavigation.hide(),Backbone.Mediator.sub(WidgetEvent.RESIZE,this.resize,this),Backbone.Mediator.sub(WidgetEvent.RENDER_LAYOUT,this.resize,this),Backbone.Mediator.sub(WidgetEvent.PAGE_TURN_START,this.pageTurnStart,this),Backbone.Mediator.sub(WidgetEvent.PAGE_TURN_CANCELED,this.pageTurnCanceled,this),Backbone.Mediator.sub(WidgetEvent.FULLSCREEN_CHANGED,this.handleFullScreenChanged,this),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayType",this.displayTypeChange),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentItem",this.itemChanged),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentPageIndex",this.pageChanged),this.listenTo(FSWidgetModel.gi().widgetState,"change:isBuyCurtainDisplayed",this.handleBuyCurtain),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:singlePageView",this.widgetSettingsChanged),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableSounds",this.widgetSettingsChanged),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:arabicStyle",this.widgetSettingsChanged),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:mergePdfs",this.widgetSettingsChanged),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:showPageShadows",this.widgetSettingsChanged),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:showControls",this.resize),this.isMobileDevice&&(this.$el.on("touchstart",$.proxy(this,"handleTouchStart")),this.$el.on("touchend touchcancel",$.proxy(this,"handleTouchEnd"))),this.resize()},createPageNavigation:function(){this.pageNavigation1=new PageNavigationView({model:new Backbone.Model({totalPages:this.totalItemPages,currentPage:this.docPageIndex,displayType:FSWidgetModel.gi().widgetState.get("displayType"),collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")],fullHeight:!this.itemNavigationVisible,maxHeight:this.$el.height()})}),this.pageNavigation2=new PageNavigationView({model:new Backbone.Model({totalPages:this.totalItemPages,currentPage:this.docPageIndex,displayType:FSWidgetModel.gi().widgetState.get("displayType"),collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")],fullHeight:!this.itemNavigationVisible,maxHeight:this.$el.height()})}),this.flipTotalPages>1&&this.$el.append(this.pageNavigation2.render().$el),this.isPlayerSkin&&this.flipViewContainer.append(this.pageNavigation2.render().el),this.pageNavigation1.on(FlipEvents.PREVIOUS_PAGE,this.sendPreviousPageEvent,this),this.pageNavigation1.on(FlipEvents.NEXT_PAGE,this.sendNextPageEvent,this),this.pageNavigation2.on(FlipEvents.PREVIOUS_PAGE,this.sendPreviousPageEvent,this),this.pageNavigation2.on(FlipEvents.NEXT_PAGE,this.sendNextPageEvent,this)},createItemNavigation:function(){this.itemNavigation=new ItemNavigationView({model:new Backbone.Model({totalItems:this.totalItems,currentItem:FSWidgetModel.gi().widgetState.get("currentItemIndex"),prevlabel:FSWidgetModel.gi().get("labels").l_prevLabelText,nextlabel:FSWidgetModel.gi().get("labels").l_nextLabelText,collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")]})}),this.$el.append(this.itemNavigation.render().$el),this.itemNavigation.on(FlipEvents.PREVIOUS_ITEM,this.sendPreviousItemEvent,this),this.itemNavigation.on(FlipEvents.NEXT_ITEM,this.sendNextItemEvent,this)},createDocumentView:function(){var buttonsTotalWidth;buttonsTotalWidth=this.isMobileDevice&&FSUtils.isInFullScreen()&&$(window).width()<$(window).height()?0:this.pageNavigation1.getButtonsTotalWidth(),this.docView=new DocumentView({model:new DocumentModel({displayType:FSWidgetModel.gi().widgetState.get("displayType"),maxSize:[Math.floor(this.$el.width()-buttonsTotalWidth),Math.floor(this.$el.height())],collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")],item:this.localItem,currentPageIndex:this.docPageIndex,offset:this.$el.offset(),navButtonWidth:buttonsTotalWidth/2,singlePageView:this.isSinglePageView,arabicStyle:this.isArabicStyle,enableSounds:FSWidgetModel.gi().widgetSettings.get("enableSounds"),showPageShadows:FSWidgetModel.gi().widgetSettings.get("showPageShadows"),mergePdfs:FSWidgetModel.gi().widgetSettings.get("mergePdfs"),retryFirstItem:!1,navigationView:this.pageNavigation1})}),this.docView.on(FlipEvents.FLIP_TAP,this.sendClickOrTapEvent,this),this.docView.on(FlipEvents.PREVIOUS_PAGE,this.sendPreviousPageEvent,this),this.docView.on(FlipEvents.NEXT_PAGE,this.sendNextPageEvent,this),this.docView.on(FlipEvents.FLIP_POSITIONED,this.positionPageNav,this),this.docView.on(WidgetEvent.PAGE_TURN_END,this.pageTurnEnd,this),this.docView.on(WidgetEvent.PAGE_CHANGED,this.docPageChanged,this),this.$el.append(this.docView.render().$el)},createGenericElementsContainer:function(){this.$genericElements=this.$el.find("#genericElements")},render:function(){return this},resize:function(){var buttonsTotalWidth,w=this.$el.width(),h=this.$el.height();FSUtils.isPlayerSkin()&&this.$el.css({top:($(window).height()-h)/2}),buttonsTotalWidth=this.isMobileDevice&&FSUtils.isInFullScreen()&&$(window).width()<$(window).height()?0:this.pageNavigation1.getButtonsTotalWidth(),"number"==typeof this.docView.bookScale&&this.docView.bookScale>1||(this.itemNavigationVisible&&(this.itemNavigation.model.set({collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")]}),h-=this.itemNavigation.getHeight()),this.pageNavigation1.model.set({collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")],maxHeight:"number"==typeof this.docViewHeight&&this.docViewHeight>0?this.docViewHeight:h,displayType:FSWidgetModel.gi().widgetState.get("displayType")}),this.pageNavigation2.model.set({collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")],maxHeight:"number"==typeof this.docViewHeight&&this.docViewHeight>0?this.docViewHeight:h,displayType:FSWidgetModel.gi().widgetState.get("displayType")}),this.docView.model.set({maxSize:[Math.floor(w-buttonsTotalWidth),Math.floor(h)],collectionSize:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")],displayType:FSWidgetModel.gi().widgetState.get("displayType"),offset:this.$el.offset(),navButtonWidth:buttonsTotalWidth/2}))},displayTypeChange:function(){this.docView.model.set("displayType",FSWidgetModel.gi().widgetState.get("displayType")),this.pageNavigation1.model.set("displayType",FSWidgetModel.gi().widgetState.get("displayType")),this.pageNavigation2.model.set("displayType",FSWidgetModel.gi().widgetState.get("displayType")),FSWidgetModel.gi().widgetState.get("displayType")===DisplayType.SMALL&&this.totalItems>1?(this.itemNavigationVisible=!0,this.itemNavigation.show(),this.pageNavigation1.model.set({fullHeight:!1}),this.pageNavigation2.model.set({fullHeight:!1})):(this.itemNavigationVisible=!1,this.itemNavigation.hide(),this.pageNavigation1.model.set({fullHeight:!0}),this.pageNavigation2.model.set({fullHeight:!0})),this.resize()},handleFullScreenChanged:function(obj){obj.displayState===DisplayState.NORMAL&&this.resize()},sendPreviousItemEvent:function(){Backbone.Mediator.pub(WidgetEvent.PREV_ITEM)},sendNextItemEvent:function(){Backbone.Mediator.pub(WidgetEvent.NEXT_ITEM)},sendPreviousPageEvent:function(){Backbone.Mediator.pub(WidgetEvent.PREV_PAGE)},sendNextPageEvent:function(){Backbone.Mediator.pub(WidgetEvent.NEXT_PAGE)},itemChanged:function(){this.processCurrentItem(),this.itemNavigation.model.set({currentItem:FSWidgetModel.gi().widgetState.get("currentItemIndex")}),this.pageNavigation1.model.set({totalPages:this.totalItemPages,currentPage:this.docPageIndex}),this.pageNavigation2.model.set({totalPages:this.totalItemPages,currentPage:this.docPageIndex}),this.docView.model.set({item:this.localItem,currentPageIndex:this.docPageIndex})},processCurrentItem:function(){this.generateLocalItem(),this.totalItemPages=this.localItem.get("pages").length,this.docPageIndex=this.calculatePageIndexForLocal(FSWidgetModel.gi().widgetState.get("currentPageIndex"))},generateLocalItem:function(){var itemPageList=FSWidgetModel.gi().widgetState.get("currentItem").get("pages").clone();this.localItem=FSWidgetModel.gi().widgetState.get("currentItem").clone(),this.localItem.set({pages:itemPageList,forms:[]}),this.isSinglePageView&&this.addBlankPages()},addBlankPages:function(){var len,pageList=this.localItem.get("pages"),i=0;for(pageList.at(pageList.length-1).get("type")===PageType.EMPTY_PAGE&&pageList.pop(),len=pageList.length;i<len;i++)this.localItem.addBlankPage(this.isArabicStyle,this.isArabicStyle?2*i:2*i+1);this.localItem.set("noOfPages",this.localItem.get("pages").length)},calculatePageIndexForLocal:function(widgetPageIndex){return this.isSinglePageView?this.isArabicStyle?2*widgetPageIndex+1:2*widgetPageIndex:widgetPageIndex},calculatePageIndexForWidget:function(docViewPageIndex){return this.isSinglePageView?this.isArabicStyle?Math.round(docViewPageIndex/2-1):Math.round(docViewPageIndex/2):docViewPageIndex},pageChanged:function(){this.docPageIndex=this.calculatePageIndexForLocal(FSWidgetModel.gi().widgetState.get("currentPageIndex")),this.pageNavigation1.model.set({currentPage:this.docPageIndex}),this.pageNavigation2.model.set({currentPage:this.docPageIndex}),this.docView.model.set({lastPageIndex:this.docView.model.get("currentPageIndex"),currentPageIndex:this.docPageIndex})},docPageChanged:function(pageIndex){var widgetPageIndex;this.docPageIndex=pageIndex%2==0?Math.max(pageIndex-1,0):pageIndex,widgetPageIndex=this.calculatePageIndexForWidget(this.docPageIndex),Backbone.Mediator.pub(WidgetEvent.PAGE_CHANGED,widgetPageIndex)},pageTurnStart:function(obj){FSWidgetModel.gi().widgetState.get("isBuyCurtainDisplayed")||(this.isSinglePageView?this.isArabicStyle?obj.nextPageIndex===this.totalItemPages-1?(this.pageNavigation1.hideNext(),this.pageNavigation2.hideNext(),this.totalItemPages>4&&(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious())):2===obj.nextPageIndex&&(this.pageNavigation1.hidePrevious(),this.pageNavigation2.hidePrevious(),this.totalItemPages>2&&obj.previousPageIndex<this.totalItemPages-1&&(this.pageNavigation1.showNext(),this.pageNavigation2.showNext())):obj.nextPageIndex===this.totalItemPages-3?(this.pageNavigation1.hideNext(),this.pageNavigation2.hideNext(),this.totalItemPages>2&&obj.nextPageIndex>1&&(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious())):0===obj.nextPageIndex&&(this.pageNavigation1.hidePrevious(),this.pageNavigation2.hidePrevious(),this.totalItemPages>4&&(this.pageNavigation1.showNext(),this.pageNavigation2.showNext())):obj.nextPageIndex===this.totalItemPages-1?(this.pageNavigation1.hideNext(),this.pageNavigation2.hideNext(),this.totalItemPages>2&&(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious())):0===obj.nextPageIndex&&(this.pageNavigation1.hidePrevious(),this.pageNavigation2.hidePrevious(),this.totalItemPages>2&&(this.pageNavigation1.showNext(),this.pageNavigation2.showNext())))},pageTurnEnd:function(obj){FSWidgetModel.gi().widgetState.get("isBuyCurtainDisplayed")||(this.isSinglePageView&&this.isArabicStyle&&obj.currentPageIndex>2||this.isSinglePageView&&!this.isArabicStyle&&obj.currentPageIndex>0||!this.isSinglePageView&&obj.currentPageIndex>0?(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious()):(this.pageNavigation1.hidePrevious(),this.pageNavigation2.hidePrevious()),this.isSinglePageView&&!this.isArabicStyle&&obj.currentPageIndex<this.totalItemPages-3||this.isSinglePageView&&this.isArabicStyle&&obj.currentPageIndex<this.totalItemPages-1||!this.isSinglePageView&&obj.currentPageIndex<this.totalItemPages-1?(this.pageNavigation1.showNext(),this.pageNavigation2.showNext()):(this.pageNavigation1.hideNext(),this.pageNavigation2.hideNext()),Backbone.Mediator.pub(WidgetEvent.PAGE_TURN_END,{currentPageIndex:this.calculatePageIndexForWidget(obj.currentPageIndex)}))},pageTurnCanceled:function(obj){var currentPageIndex=this.docPageIndex;FSWidgetModel.gi().widgetState.get("isBuyCurtainDisplayed")||(this.isSinglePageView?this.isArabicStyle?(currentPageIndex>1&&(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious()),currentPageIndex<this.totalItemPages-1&&(this.pageNavigation1.showNext(),this.pageNavigation2.showNext())):(currentPageIndex>0&&(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious()),currentPageIndex<this.totalItemPages-3&&(this.pageNavigation1.showNext(),this.pageNavigation2.showNext())):1===currentPageIndex&&2===obj.page&&1===obj.next?(this.pageNavigation1.showPrevious(),this.pageNavigation2.showPrevious()):currentPageIndex!==this.totalItemPages-3&&0!==currentPageIndex||obj.page!==this.totalItemPages-1||obj.next!==this.totalItemPages||(this.pageNavigation1.showNext(),this.pageNavigation2.showNext()))},sendClickOrTapEvent:function(){Backbone.Mediator.pub(WidgetEvent.WIDGET_CLICK_OR_TAP)},positionPageNav:function(obj){"number"==typeof this.docView.bookScale&&this.docView.bookScale>1||(this.docViewHeight=obj.height,this.pageNavigation1.model.set({flipViewLeft:obj.left,navDistance:obj.width,maxHeight:obj.height}),this.pageNavigation2.model.set({flipViewLeft:obj.left,navDistance:obj.width,maxHeight:obj.height}),this.docView.flipbook.css("navButtonWidth",this.pageNavigation1.getButtonsTotalWidth()/2),this.docView.flipbook.css("navButtonWidth",this.pageNavigation2.getButtonsTotalWidth()/2))},widgetSettingsChanged:function(dataModel){"arabicStyle"in dataModel.changed&&(this.isArabicStyle=dataModel.changed.arabicStyle),"singlePageView"in dataModel.changed&&(this.isSinglePageView=dataModel.changed.singlePageView),this.docView.model.set(dataModel.changed)},remove:function(){this.pageNavigation1&&(this.pageNavigation1.off(),this.pageNavigation1.remove(),this.pageNavigation1=null),this.pageNavigation2&&(this.pageNavigation2.off(),this.pageNavigation2.remove(),this.pageNavigation2=null),this.itemNavigation&&(this.itemNavigation.off(),this.itemNavigation.remove(),this.itemNavigation=null),this.docView&&(this.docView.off(),this.docView.remove(),this.docView=null),this.$el.off(),Backbone.Mediator.unsubscribe(WidgetEvent.RESIZE,this.resize,this),Backbone.Mediator.unsubscribe(WidgetEvent.RENDER_LAYOUT,this.resize,this),Backbone.Mediator.unsubscribe(WidgetEvent.PAGE_TURN_START,this.pageTurnStart,this),Backbone.Mediator.unsubscribe(WidgetEvent.PAGE_TURN_CANCELED,this.pageTurnCanceled,this),Backbone.Mediator.unsubscribe(WidgetEvent.FULLSCREEN_CHANGED,this.handleFullScreenChanged,this),Backbone.View.prototype.remove.apply(this,arguments)},handleTouchStart:function(e){var touchList=e.originalEvent.touches;this.isMultiTouch&&this.handleTouchEnd(e),this.isInFullScreen=FSUtils.isInFullScreen(),this.deltaX=0,this.isMultiTouch=!1,window.touchObj={touch1:{},touch2:{}},this.isInFullScreen||this.isPlayerSkin?touchList&&2===touchList.length?(e.preventDefault(),e.stopPropagation(),window.touchObj.startZoom=this.docView.currentZoom,this.isMultiTouch=!0,this.docView.model.set("isMultiTouch",!0),window.touchObj.touch1={startX:touchList[0].pageX,startY:touchList[0].pageY,currentX:0,currentY:0},window.touchObj.touch2={startX:touchList[1].pageX,startY:touchList[1].pageY,currentX:0,currentY:0},window.touchObj.initialDeltaX=Math.abs(window.touchObj.touch2.startX-window.touchObj.touch1.startX),window.touchObj.initialDeltaY=Math.abs(window.touchObj.touch2.startY-window.touchObj.touch1.startY)):FSWidgetModel.gi().get("currentZoom")>0?(e.pageX=touchList[0].pageX,e.pageY=touchList[0].pageY,this.docView.mouseDownDocView(e)):this.touchStartPosX=this.currentTouchPosX=touchList[0].pageX:touchList&&1===touchList.length&&(this.touchStartPosX=this.currentTouchPosX=touchList[0].pageX),this.$el.on("touchmove",$.proxy(this.handleTouchMove,this))},handleTouchMove:function(e){var touchList=this.isIOS?e.originalEvent.touches:e.originalEvent.changedTouches;1===touchList.length&&(this.currentTouchPosX=touchList[0].pageX,this.deltaX=this.currentTouchPosX-this.touchStartPosX),(this.isInFullScreen||this.isPlayerSkin)&&(this.isMultiTouch?touchList&&2===touchList.length&&(e.preventDefault(),e.stopPropagation(),window.touchObj.touch1.currentX=touchList[0].pageX,window.touchObj.touch1.currentY=touchList[0].pageY,window.touchObj.touch2.currentX=touchList[1].pageX,window.touchObj.touch2.currentY=touchList[1].pageY,window.requestAnim(this.doPinchZoom)):FSWidgetModel.gi().get("currentZoom")>0&&(e.pageX=touchList[0].pageX,e.pageY=touchList[0].pageY,this.docView.mouseMoveDocView(e)))},doPinchZoom:function(){var deltaX,deltaY,percent,newZoom,pinchZoomDeltaX,pinchZoomDeltaY,maxZoom=FSWidgetModel.gi().get("maxZoomValue");deltaX=Math.abs(window.touchObj.touch2.currentX-window.touchObj.touch1.currentX),deltaY=Math.abs(window.touchObj.touch2.currentY-window.touchObj.touch1.currentY),pinchZoomDeltaX=deltaX-window.touchObj.initialDeltaX,pinchZoomDeltaY=deltaY-window.touchObj.initialDeltaY,percent=Math.abs(pinchZoomDeltaX)>Math.abs(pinchZoomDeltaY)?pinchZoomDeltaX/$(window).width():pinchZoomDeltaY/$(window).height(),percent*=FlipView.ZOOM_FACTOR,newZoom=window.touchObj.startZoom+percent,newZoom=percent<0&&newZoom<=.05?0:newZoom,newZoom=Math.min(maxZoom,newZoom),Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:newZoom})},handleTouchEnd:function(e){var touches,x,y,currentTime=(new Date).getTime(),tapLength=currentTime-this.lastTap,self=this;clearTimeout(this.timeout),e.originalEvent&&e.originalEvent.changedTouches&&(touches=e.originalEvent.changedTouches,0===FSWidgetModel.gi().get("currentZoom")&&1===touches.length&&!this.isMultiTouch&&Math.abs(this.deltaX)>FlipView.SWIPE_THRESHOLD&&(e.preventDefault(),e.stopPropagation(),this.currentTouchPosX<this.touchStartPosX?Backbone.Mediator.pub(WidgetEvent.NEXT_PAGE):Backbone.Mediator.pub(WidgetEvent.PREV_PAGE)),this.isMultiTouch||(x=touches[0].clientX,y=touches[0].clientY,tapLength<DocumentView.DOUBLE_TAP_TIMEOUT&&tapLength>0?(e.preventDefault(),x<this.firstTouchPos.x+DocumentView.DOUBLE_TAP_RADIUS&&x>this.firstTouchPos.x-DocumentView.DOUBLE_TAP_RADIUS&&y<this.firstTouchPos.y+DocumentView.DOUBLE_TAP_RADIUS&&y>this.firstTouchPos.y-DocumentView.DOUBLE_TAP_RADIUS&&(this.docView.enterZoom(e),this.lastTap=0,clearTimeout(this.timeout),this.firstTouchPos=null)):(this.timeout=setTimeout(function(){clearTimeout(self.timeout)},DocumentView.DOUBLE_TAP_TIMEOUT),this.lastTap=currentTime,this.firstTouchPos={x:x,y:y}))),this.isMultiTouch||FSWidgetModel.gi().get("currentZoom")>0?(this.isMultiTouch?(Backbone.Mediator.pub(WidgetEvent.ZOOM_END,{value:FSWidgetModel.gi().get("currentZoom")}),this.isMultiTouch=!1,this.docView.model.set("isMultiTouch",!0),e.preventDefault(),e.stopPropagation()):this.docView.mouseUpDocView(),window.touch1={},window.touch2={}):this.docView.mouseUpDocView(),this.deltaX=0,this.$el.off("touchmove")},handleBuyCurtain:function(){var isBuyCurtainDisplayed=FSWidgetModel.gi().widgetState.get("isBuyCurtainDisplayed");this.pageNavigation1.model.set("isBuyCurtainDisplayed",isBuyCurtainDisplayed),this.pageNavigation2.model.set("isBuyCurtainDisplayed",isBuyCurtainDisplayed)}}),FlipView.SMALL_MAX_WIDTH=700,FlipView.SMALL_MAX_HEIGHT=700,FlipView.SWIPE_THRESHOLD=75,FlipView.ZOOM_FACTOR=5,FlipView._instance=null,FlipView.gi=function(){return FlipView._instance||(FlipView._instance=new FlipView),FlipView._instance},Backbone.Mediator.sub(WidgetEvent.CONFIG_DONE,function(){FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelfOpened")||(FSWidgetModel.gi().widgetState.get("currentItem").get("hasCustomContent")?window.CustomContentView?FlipView.gi():Backbone.Mediator.sub(WidgetEvent.CUSTOM_VIEW_LOADED,callCreateWhenCustomViewLoaded,context):FlipView.gi())},this),Backbone.Mediator.sub(WidgetEvent.DESTROY,function(){FlipView._instance&&(FlipView.gi().remove(),FlipView._instance=null)},this)}();var MenuTemplates={shareButton:'<span class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 -2 18 20"><path d="M6 8.617c0 .058-.013.113-.017.171l6.091 3.045A2.97 2.97 0 0 1 14 11.115a3 3 0 1 1-3 3c0-.06.014-.113.017-.17L4.926 10.9A2.98 2.98 0 0 1 3 11.615a3 3 0 0 1 0-6 2.98 2.98 0 0 1 1.926.718l6.09-3.045C11.015 3.23 11 3.175 11 3.115a3 3 0 1 1 3 3.002 2.967 2.967 0 0 1-1.926-.719l-6.09 3.046c.002.059.016.113.016.173z"/></svg><label><%- label %></label></span>',downloadButton:'<a class="btn" href="<%- link %>" target="<%- target %>" rel="nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewBox="0 0 19 20"><path d="M5 6.5a1 1 0 0 1 1.4 0l1.4 1.3V2A1 1 0 1 1 10 2v6l.5-.6 1-1a1 1 0 0 1 1.6 0c.4.3.5.7.4 1a1 1 0 0 1 0 .4H13V8l-1.7 1.6-1.7 1.7a1 1 0 0 1-.8.4c-.3 0-.6 0-.8-.4L6.5 9.6 5 8a1 1 0 0 1-.2 0v-.2a1.2 1.2 0 0 1-.2-.3 1 1 0 0 1 .3-1zm12.5 10.8c0 1.5-1.5 2.7-3.4 2.7H4c-2 0-3.4-1.2-3.4-2.7V10C.4 9 1.4 8 3 7.6c0 .6.3 1.2.7 1.7l.5.4h-.4c-.8 0-1.2.4-1.2.5v7.3c0 .2.4.5 1.2.5H14c1 0 1.3-.3 1.3-.5V10s-.4-.4-1.2-.4H14l.4-.4a2.7 2.7 0 0 0 .8-1.7c1.5.3 2.5 1.4 2.5 2.6v7.3z"/></svg><label><%- label %></label></a>',printButton:'<a class="btn" href="<%- link %>" target="<%- target %>" rel="nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewBox="0 0 19 20"><path fill-rule="nonzero" d="M17.813 4.75H1.188C.532 4.75 0 5.283 0 5.938v7.125c0 .656.532 1.187 1.188 1.187h2.375v3.563c0 .657.531 1.188 1.187 1.188h9.5c.656 0 1.187-.531 1.187-1.188V14.25h2.376c.656 0 1.187-.53 1.187-1.187V5.938c0-.655-.531-1.188-1.187-1.188zM14.25 17.813h-9.5v-7.125h9.5v7.125zm2.375-9.5a1.187 1.187 0 1 1-.001-2.374 1.187 1.187 0 0 1 0 2.374zM4.75 1.188v2.375H3.563V1.188C3.563.532 4.094 0 4.75 0h9.5c.656 0 1.188.532 1.187 1.188v2.375H14.25V1.188h-9.5z"/></svg><label><%- label %></label></a>',searchButton:'<span class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="21" viewBox="0 -2 20 21"><path d="M17.2 13.2c3-3 3-8 0-11s-8-3-11 0c-2.5 2.6-3 6.4-1 9.4v.3l-4 4c-1 .7-1 1.8-.3 2.5.7.8 1.8.6 2.5-.2l4-4H8a7.6 7.6 0 0 0 9.2-1zm-9.5-1.5a5.7 5.7 0 0 1 0-8 5.7 5.7 0 0 1 8 0 5.7 5.7 0 0 1 0 8 5.7 5.7 0 0 1-8 0z"/></svg><label><%- label %></label></svg>',zoomButton:'<span class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="23" viewBox="0 0 17 17"><path d="M6.7 12.8s-.2-.2-.4 0l-3.5 3.5c-.7.7-1.7.8-2.3.2l-.1-.1c-.7-.6-.5-1.6.2-2.3l3.5-3.5c.1-.1 0-.3 0-.3-1.6-2.6-1.3-6 1-8.3 2.7-2.7 7.1-2.7 9.8 0s2.7 7.1 0 9.8c-2.3 2.3-5.7 2.6-8.2 1zm6.9-2.3c2-2 2-5.2 0-7.2s-5.2-2-7.2 0-2 5.2 0 7.2 5.2 2 7.2 0zm-.5-4.4v1.5h-2.2v2.3H9.2V7.6H7V6.1h2.2V3.9h1.7v2.2h2.2z" /></svg><label><%- label %></label></span>',buttonX:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 26 26"><path d="M15.3 13L25.5 2.8A1.6 1.6 0 1 0 23.2.5L13 10.7 2.8.5A1.6 1.6 0 1 0 .5 2.8L10.7 13 .5 23.2a1.6 1.6 0 1 0 2.3 2.3L13 15.3l10.2 10.2a1.6 1.6 0 0 0 2.3 0 1.6 1.6 0 0 0 0-2.3L15.3 13z"/> </svg>',menuOptionsContent:'<div class="content"></div><div class="arrow"><div></div></div>',menuOptionElement:'<a href="<%- link %>" rel="nofollow noopener noreferrer" target="<%- target %>"></a>',menuOptionLink:'<input type="text" id="share-link-input" value="<%- link %>" readonly /><span id="share-link-confirmation"><%- confirmMessage %></span>',tocButton:'<span class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="23" height="18" viewBox="0 0 23 18"><defs><filter id="a" width="131.6%" height="142.9%" x="-15.8%" y="-21.4%" filterUnits="objectBoundingBox"><feOffset in="SourceAlpha" result="shadowOffsetOuter1"/><feGaussianBlur in="shadowOffsetOuter1" result="shadowBlurOuter1" stdDeviation="1"/><feComposite in="shadowBlurOuter1" in2="SourceAlpha" operator="out" result="shadowBlurOuter1"/><feColorMatrix in="shadowBlurOuter1" result="shadowMatrixOuter1" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.298969656 0"/><feMerge><feMergeNode in="shadowMatrixOuter1"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path d="M4.176 5H.963a.912.912 0 0 0-.682.292A.983.983 0 0 0 0 6v2c0 .278.094.514.281.708A.913.913 0 0 0 .963 9h3.213a.913.913 0 0 0 .682-.292A.982.982 0 0 0 5.14 8V6a.983.983 0 0 0-.28-.708A.913.913 0 0 0 4.175 5zm0-5H.963a.912.912 0 0 0-.682.292A.983.983 0 0 0 0 1v2c0 .278.094.514.281.708A.913.913 0 0 0 .963 4h3.213a.913.913 0 0 0 .682-.292A.983.983 0 0 0 5.14 3V1a.984.984 0 0 0-.28-.708A.913.913 0 0 0 4.175 0zm0 10H.963a.912.912 0 0 0-.682.292A.983.983 0 0 0 0 11v2c0 .278.094.514.281.708A.912.912 0 0 0 .963 14h3.213a.913.913 0 0 0 .682-.292A.982.982 0 0 0 5.14 13v-2a.983.983 0 0 0-.28-.708.913.913 0 0 0-.683-.292zM17.6 5H7.962a.912.912 0 0 0-.682.292A.983.983 0 0 0 7 6v2c0 .278.094.514.281.708A.912.912 0 0 0 7.963 9H17.6a.912.912 0 0 0 .682-.292.982.982 0 0 0 .28-.708V6a.982.982 0 0 0-.28-.708.912.912 0 0 0-.683-.292zm0 5H7.962a.912.912 0 0 0-.682.292A.983.983 0 0 0 7 11v2c0 .278.094.514.281.709a.912.912 0 0 0 .682.291H17.6a.912.912 0 0 0 .682-.291.983.983 0 0 0 .28-.709v-2a.982.982 0 0 0-.28-.708.913.913 0 0 0-.683-.292zm.682-9.708A.912.912 0 0 0 17.599 0H7.963a.912.912 0 0 0-.682.292A.983.983 0 0 0 7 1v2c0 .278.094.514.281.708A.913.913 0 0 0 7.963 4H17.6a.913.913 0 0 0 .682-.292.982.982 0 0 0 .28-.708V1a.982.982 0 0 0-.28-.708z" filter="url(#a)" transform="translate(2 2)"/></svg><label><%- label %></label></span>',tableOfContent:{content:'<div class="content"></div>',header:'<span class="name">Table of content</span><span class="close"/>',row:'<div class="row-header"><span title="<%- title %>" class="title"><%- title %></span></div><div class="subnodes"></div>',arrow:'<svg width="6" height="10" viewBox="0 0 6 10" xmlns="http://www.w3.org/2000/svg"><path d="M1.11 0L0 1.097 3.646 4.7 0 8.303 1.11 9.4l4.756-4.7z" fill-rule="nonzero"/></svg>'},shareIcons:{facebook:'<svg xmlns="http://www.w3.org/2000/svg" width="9" height="19" viewBox="0 0 9 19"><path d="M6.7 3.6H9V0H6.3c-3.3 0-4 2-4 4.2V6H0v3.5h2.2V19h3.4V9.5h2.8L9 6H5.5V5c0-.8.5-1.4 1-1.4z"/></svg>',twitter:'<svg xmlns="http://www.w3.org/2000/svg" width="19" height="16" viewBox="0 0 19 16"><path d="M18.5 1.8a7.4 7.4 0 0 1-2.2.6 4 4 0 0 0 1.6-2 7.5 7.5 0 0 1-2.5.8A3.7 3.7 0 0 0 12.8 0C10.8 0 9 1.7 9 4v.8C6 4.6 3.3 3 1.4.8a4 4 0 0 0-.5 2 4 4 0 0 0 1.7 3 3.7 3.7 0 0 1-1.8-.4c0 2 1.3 3.5 3 4a3.7 3.7 0 0 1-1 0h-.6c.6 1.5 2 2.6 3.6 2.6A7.5 7.5 0 0 1 0 13.6a10.5 10.5 0 0 0 5.8 1.8c7 0 10.8-6 10.8-11v-.6a7.7 7.7 0 0 0 2-2z"/></svg>',instagram:'<svg xmlns="http://www.w3.org/2000/svg" width="21" height="20" viewBox="0 0 21 20"><path d="M15.6 3.2c-.4 0-.7 0-1 .3-.2.3-.3.6-.3 1 0 .2 0 .5.3.8a1.4 1.4 0 0 0 2 0c0-.3.3-.6.3-1 0-.2-.3-.5-.5-.8a1.4 1.4 0 0 0-1-.3zM10 4.6c-2.8 0-5 2.2-5 5 0 2.7 2.2 5 5 5s5.3-2.3 5.3-5c0-2.8-2.3-5-5.2-5zm0 8.2c-1.8 0-3.3-1.5-3.3-3.3 0-1.7 1.5-3.2 3.4-3.2 2 0 3.5 1.5 3.5 3.2 0 1.8-1.5 3.3-3.4 3.3zM14.7 0h-9C2.6 0 0 2.4 0 5.3v8.5c0 3 2.5 5.3 5.6 5.3h9c3 0 5.6-2.3 5.6-5.2V5.3c0-3-2.5-5.3-5.6-5.3zm0 17.4h-9c-2 0-3.8-1.6-3.8-3.6V5.3c0-2 1.7-3.6 3.8-3.6h9c2 0 3.8 1.6 3.8 3.6v8.5c0 2-1.7 3.6-3.8 3.6z"/></svg>',googleplus:'<svg xmlns="http://www.w3.org/2000/svg" width="27" height="16" viewBox="0 0 27 16"><path d="M26.7 9.15h-2.617v2.565H21.9V9.15h-2.617V7.014H21.9V4.45h2.182v2.564H26.7V9.15zM8.272 15.94C3.682 15.94 0 12.442 0 7.97 0 3.498 3.682 0 8.272 0c2.227 0 4.182.62 5.59 1.948l-2.408 2.347C10.68 3.498 9.544 3.1 8.272 3.1c-2.727 0-5.09 2.213-5.09 4.87s2.363 4.87 5.09 4.87c2.273 0 4-1.416 4.5-3.542h-4.59v-3.1h8c.09.532.135 1.196.135 1.772a9.57 9.57 0 0 1-.136 1.638c-.636 4.118-3.817 6.332-7.908 6.332z"/></svg>',pinterest:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="19" viewBox="0 0 16 19"><path d="M9 14.4c-1.2 0-2.3-.7-2.7-1.5l-.8 3c-.2 1-.7 1.8-1 2.5-.7.7-1.3.2-1.4-.5 0-.8 0-1.7.3-2.6l1.4-6.2s-.4-.7-.4-1.8c0-1.7 1-3 2.2-3 1 0 1.5.8 1.5 1.7 0 1.2-.6 2.8-1 4.2-.3 1.2.6 2.2 1.8 2.2 2 0 3.5-2.8 3.5-6 0-2.6-1.6-4.4-4.6-4.4-3.4 0-5.5 2.5-5.5 5.4 0 1 .3 1.7.7 2.3v.6l-.2 1c0 .2-.3.3-.5.2C.7 10.8 0 9 0 7c0-3 2.7-7 8-7 4.2 0 7 3.2 7 6.5 0 4.5-2.4 8-6 8z"/></svg>',email:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="19" viewBox="0 0 24 19"><path d="M23.8 17.3a1 1 0 0 1-.2.4c-.5.8-1.2 1.2-2 1.2H2.4c-.7 0-1.4-.5-2-1a1 1 0 0 1-.2-.8 3 3 0 0 1-.2-1V2.6C0 1.2 1 0 2.4 0h19.2c.6 0 1.2.3 1.6.7a.7.7 0 0 1 .2.2c.4.4.6 1 .6 1.6v13.6c0 .4 0 .8-.2 1zm-2-.2L15 10l-2.4 2.5-.6.2a.7.7 0 0 1-.5-.2L9 10l-6.7 7h19.3a.7.7 0 0 0 .2 0zm.6-1.7V3l-6.2 6 6.2 6.3zm-20.8 0L7.8 9 1.6 3v12.3zM3 1.8l9 8.8 9.2-8.8H3z"/></svg>'},searchInput:'<input type="search" /><div class="results-nr" /><div class="clear-results <%- hideClearButton %>"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="#FFF" fill-rule="evenodd" d="M.31.286a1 1 0 011.413 0L10 8.563 18.277.286a1 1 0 011.414 0l.023.023a1 1 0 010 1.414L11.437 10l8.277 8.277a1 1 0 01.083 1.32l-.083.094-.023.023a1 1 0 01-1.414 0L10 11.437l-8.277 8.277a1 1 0 01-1.414 0l-.023-.023a1 1 0 010-1.414L8.563 10 .286 1.723A1 1 0 01.203.403L.286.31z"/></svg></div>',searchResults:'<div class="results-nr"><%- resultCountText %></div><div class="search-result-list"></div>',searchResult:'<div class="title"><%- title %></div><div class="html"><%= html %></div>',zoom:'<div class="content"><span class="zoom-min zoom-action" /><span class="zoom-slider"><span class="zoom-btn zoom-slider-btn"></span></span><span class="zoom-plus zoom-action" /></div><div class="arrow"><div></div></div>',zoomPlayer:'<div class="content"><span class="zoom-min zoom-action" /><span class="zoom-slider"><span class="zoom-slider-progress"></span><span class="zoom-btn zoom-slider-btn"></span></span><span class="zoom-plus zoom-action" /></div>',enterFullscreenPlayer:'<span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path fill="#FFF" fill-rule="evenodd" d="M19 12a1 1 0 011 1v6a1 1 0 01-.883.993L19 20h-6a1 1 0 010-2h5v-5a1 1 0 011-1zM1 12a1 1 0 011 1v5h5a1 1 0 010 2H1a1 1 0 01-1-1v-6a1 1 0 011-1zM7 0a1 1 0 110 2l-5-.001V7a1 1 0 11-2 0V1a1 1 0 011-1h6zm12 0a1 1 0 011 1v6a1 1 0 01-2 0V2h-5a1 1 0 010-2h6z" /></svg><label><%- label %></label></span',leaveFullscreenPlayer:'<span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"> <path fill="#FFF" fill-rule="evenodd" d="M19 12c.552 0 1 .448 1 1s-.448 1-1 1h-5v5c0 .552-.448 1-1 1s-1-.448-1-1v-6c0-.552.448-1 1-1h6zM7 12c.552 0 1 .448 1 1v6c0 .552-.448 1-1 1s-1-.448-1-1v-5H1c-.552 0-1-.448-1-1s.448-1 1-1h6zM7 0c.552 0 1 .448 1 1v6c0 .513-.386.936-.883.993L7 8H1c-.552 0-1-.448-1-1s.448-1 1-1h5V1c0-.552.448-1 1-1zm6 0c.552 0 1 .448 1 1v5h5c.552 0 1 .448 1 1s-.448 1-1 1h-6c-.552 0-1-.448-1-1V1c0-.552.448-1 1-1z" /></svg><label><%- label %></label></span>',downloadBtnPlayer:'<a class="btn" href="<%- link %>" target="<%- target %>" rel="nofollow noopener noreferrer"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3 5a1 1 0 110 2H2l-.001 11h16L18 7h-1a1 1 0 010-2h2a1 1 0 011 1v13a1 1 0 01-1 1H1a1 1 0 01-1-1V6a1 1 0 011-1h2zm7-5a1 1 0 011 1v12.656l2.95-2.949a1 1 0 011.32-.083l.094.083a1 1 0 010 1.414l-4.243 4.243a.998.998 0 01-.302.207 1 1 0 01-1.676-.056 1.035 1.035 0 01-.193-.151l-4.243-4.243a1 1 0 111.414-1.414L9 13.586V1a1 1 0 011-1z" fill="#FFF"/></g></svg><label><%- label %></label></a>',printBtnPlayer:'<a class="btn" href="<%- link %>" target="<%- target %>" rel="nofollow noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path fill="#FFF" d="M16 0c.552 0 1 .448 1 1v3h2c.552 0 1 .448 1 1v9c0 .552-.448 1-1 1h-2v3c0 1.054-.816 1.918-1.85 1.995L15 20H5c-1.105 0-2-.895-2-2v-3H1c-.552 0-1-.448-1-1V5c0-.552.448-1 1-1h2V1c0-.552.448-1 1-1h12zm-1 11H5v7h10v-7zm3-5H2v7h1v-2c0-.1.007-.2.022-.296l.002-.014.01-.058c.024-.129.06-.253.107-.372l.015-.036c.034-.08.072-.156.115-.23l.02-.034.049-.076.034-.05.05-.066.037-.046.057-.065.037-.04c.024-.024.047-.048.072-.071l.027-.025.072-.063.048-.038.066-.05.047-.032.068-.044.057-.033c.03-.018.06-.034.092-.05L4.13 9.2c.037-.018.075-.035.114-.051l.023-.01.079-.029.072-.023.052-.015.087-.022.07-.014.074-.013C4.8 9.008 4.9 9 5 9h10c.103 0 .203.008.302.023l.065.01.086.018.033.008.092.026.027.008.014.005c.039.012.076.026.114.04l.043.018.099.045.024.012c.033.017.066.034.098.053l.043.025.076.049.05.034.066.05.046.037.065.057.04.037c.024.024.048.047.071.072l.025.027.063.072.038.048.05.066.032.047.044.068.033.057c.06.106.111.217.152.334.055.16.09.33.104.505L17 11v2h1V6zm-3-4H5v2h10V2z"/></svg><label><%- label %></label></a>',searchBtnPlayer:'<div class="action-button-player"><span><svg width="21" height="21" xmlns="http://www.w3.org/2000/svg"><path d="M8 0a8 8 0 016.32 12.905l6.337 6.338a1 1 0 11-1.414 1.414l-6.337-6.337A8 8 0 118 0zm0 2a6 6 0 100 12A6 6 0 008 2z" fill="#FFF" fill-rule="nonzero"/></svg><label><%- label %></label></span></div>',shareBtnPlayer:'<div class="action-button-player"><span><svg width="17" height="20" xmlns="http://www.w3.org/2000/svg"><path d="M14 0a3 3 0 11-1.724 5.455L5.877 9.148a3 3 0 01-.065 1.9l6.29 3.63a3 3 0 11-1.038 1.71l-6.564-3.79a3 3 0 11.192-5.077l6.42-3.705A3.002 3.002 0 0114 0z" fill="#FFF" fill-rule="evenodd"/></svg><label><%- label %></label></span></div>',tocBtnPlayer:'<span><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><path d="M1 14a1 1 0 011 1v4a1 1 0 01-2 0v-4a1 1 0 011-1zm18 0a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4a1 1 0 011-1h14zm-1 2H6v2h12v-2zM1 7a1 1 0 011 1v4a1 1 0 01-2 0V8a1 1 0 011-1zm18 0a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V8a1 1 0 011-1h14zm-1 2H6v2h12V9zM1 0a1 1 0 011 1v4a1 1 0 11-2 0V1a1 1 0 011-1zm18 0a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V1a1 1 0 011-1h14zm-1 1.999H6V4h12V1.999z" fill="#FFF" fill-rule="evenodd"/></svg><label><%- label %></label></span>',pageNumber:"<span><%- currentPage %>  / <%- totalPages %></span>"},ZoomBar=Backbone.View.extend({events:{"mousedown .zoom-slider-btn":"onZoomDragStart","mousedown .zoom-slider":"onSliderClick","click .zoom-min":"handleClickMinus","click .zoom-plus":"handleClickPlus"},template:_.template(MenuTemplates.zoomPlayer),className:"zoomBar",initialize:function(){this.isDragging=!1,this.zoomButtonTolerance=7,this.zoomSliderTolerance=0,this.zoomStep=10,this.isMobile=FSUtils.isMobileDevice(),this.zoomValues=FSUtils.generateZoomValues(0,this.model.get("maxZoomValue"),ZoomBar.CONTROLLED_ZOOM_AMOUNT),0===this.model.get("maxZoomValue")&&this.model.set("notNeeded",!0),Backbone.Mediator.sub(WidgetEvent.ZOOM_CHANGED,this.handleZoomChanged,this),Backbone.Mediator.sub(WidgetEvent.MAX_ZOOM_CHANGED,this.updateMaxZoom,this),Backbone.Mediator.sub(WidgetEvent.ENTER_FULLSCREEN,this.resetZoom,this),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayState",this.handleDisplayModeChange),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayType",this.handleDisplayModeChange),this.listenTo(this.model,"change:zoomValue",this.handleModelZoomChanged),this.listenTo(this.model,"change:maxZoomValue",this.handleModelZoomChanged)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.on("mousedown mouseup",function(e){return!e.isDefaultPrevented()&&(Backbone.Mediator.pub(e.type,e),!0)}),this.zoomSliderBar=this.$el.find(".zoom-slider"),this.zoomSliderBtn=this.$el.find(".zoom-slider-btn"),this.zoomSliderProgress=this.$el.find(".zoom-slider-progress"),(this.model.get("notNeeded")||this.isMobile)&&this.$el.hide(),this},onSliderClick:function(e){return 1!==e.which||(this.positionZoomBtn(e),this.onZoomDragStart(e),!0)},handleClickMinus:function(e){if(1!==e.which)return!0;Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:this.model.get("zoomValue")-FSWidgetModel.gi().get("maxZoomValue")/this.zoomStep})},handleClickPlus:function(e){if(1!==e.which)return!0;Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:this.model.get("zoomValue")+FSWidgetModel.gi().get("maxZoomValue")/this.zoomStep})},onZoomDragStart:function(e){return 1!==e.which||(this.isDragging=!0,Backbone.Mediator.sub("mousemove",this.onZoomButtonDrag,this),Backbone.Mediator.sub("dragstop",this.onZoomDragStop,this),Backbone.Mediator.sub("mouseup",this.onZoomDragStop,this),Backbone.Mediator.pub(WidgetEvent.ZOOM_START),!0)},onZoomDragStop:function(){var zoomValue=this.getZoomValue();this.isDragging=!1,this.zoomSliderBtn.blur(),Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:zoomValue}),Backbone.Mediator.pub(WidgetEvent.ZOOM_END),Backbone.Mediator.unsubscribe("mousemove",this.onZoomButtonDrag,this),Backbone.Mediator.unsubscribe("dragstop",this.onZoomDragStop,this),Backbone.Mediator.unsubscribe("mouseup",this.onZoomDragStop,this)},onZoomButtonDrag:function(e){this.isDragging?this.positionZoomBtn(e):this.onZoomDragStop()},positionZoomBtn:function(e){var sliderLeft=this.zoomSliderBar.offset().left+this.zoomSliderTolerance,mousePos=e.pageX-this.zoomButtonTolerance,percent=Math.floor(Math.max(0,Math.min(mousePos-sliderLeft,this.getSliderWidth())))/this.getSliderWidth(),currentZoomValue=this.model.get("defaultZoomValue")+this.model.get("maxZoomValue")*percent,newZoomValue=isNaN(currentZoomValue)?FSWidgetModel.gi().widgetState.get("maxZoomVal"):FSUtils.getClosestZoomValue(this.zoomValues,currentZoomValue);FSWidgetModel.gi().get("currentZoom")!==newZoomValue&&Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:newZoomValue})},setSliderButtonPosition:function(newPosX){this.zoomSliderBtn.css("left",newPosX+this.zoomSliderTolerance+"px"),this.zoomSliderProgress.css("width",newPosX+this.zoomSliderTolerance+"px")},getSliderButtonPosition:function(){return parseInt(this.zoomSliderBtn.css("left"),10)-this.zoomSliderTolerance},getSliderWidth:function(){return this.model.get("notNeeded")?ZoomBar.DEFAULT_SLIDER_WIDTH:this.zoomSliderBar.width()-2*this.zoomButtonTolerance},getZoomValue:function(){var percent=this.getSliderButtonPosition()/this.getSliderWidth(),val=this.model.get("defaultZoomValue")+this.model.get("maxZoomValue")*percent;return val=isNaN(val)?FSWidgetModel.gi().widgetState.get("maxZoomVal"):val},resetZoom:function(){this.model.set("zoomValue",this.model.get("defaultZoomValue"))},handleDisplayModeChange:function(){FSWidgetModel.gi().widgetState.get("displayState")!==DisplayState.NORMAL&&FSWidgetModel.gi().widgetState.get("displayType")!==DisplayType.SMALL||this.resetZoom()},handleZoomChanged:function(obj){var minValue=Math.min(obj.value,this.model.get("maxZoomValue")),finalValue=Math.max(minValue,this.model.get("defaultZoomValue"));this.model.set("zoomValue",finalValue)},handleModelZoomChanged:function(){var percent=this.model.get("zoomValue")/this.model.get("maxZoomValue"),newPos=this.getSliderWidth()*percent;this.setSliderButtonPosition(newPos)},updateMaxZoom:function(){var maxZoom=FSWidgetModel.gi().get("maxZoomValue");this.model.set("maxZoomValue",maxZoom),this.model.set("notNeeded",0===maxZoom),this.zoomValues=FSUtils.generateZoomValues(0,maxZoom,ZoomBar.CONTROLLED_ZOOM_AMOUNT)},remove:function(){this.$el.off(),this.off(),Backbone.Mediator.unsubscribe("mousemove",this.onZoomButtonDrag,this),Backbone.Mediator.unsubscribe("dragstop",this.onZoomDragStop,this),Backbone.Mediator.unsubscribe("mouseup",this.onZoomDragStop,this),Backbone.Mediator.unsubscribe(WidgetEvent.ZOOM_CHANGED,this.handleZoomChanged,this),Backbone.Mediator.unsubscribe(WidgetEvent.MAX_ZOOM_CHANGED,this.updateMaxZoom,this),Backbone.View.prototype.remove.apply(this,arguments)}});ZoomBar.DEFAULT_SLIDER_WIDTH=90,ZoomBar.CONTROLLED_ZOOM_AMOUNT=24;var PageNumber=Backbone.View.extend({events:{},template:_.template(MenuTemplates.pageNumber),className:"pageNumber",render:function(){return this.$el.html(this.template(this.model.attributes)),this},initialize:function(){this.isMobile=FSUtils.isMobileDevice(),this.isArabicStyle=FSWidgetModel.gi().widgetSettings.get("arabicStyle"),this.isSinglePageView=FSWidgetModel.gi().widgetSettings.get("singlePageView"),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentPageIndex",this.handlePageChange),this.isMobile&&this.listenTo(FSWidgetModel.gi().widgetState,"change:rightPageIndex",this.handlePageChange)},handlePageChange:function(e){var totalPages=e.get("currentItem").attributes.pages.length,leftPage=e.attributes.leftPageIndex<0?0:e.attributes.leftPageIndex,currentPageLeft=this.isArabicStyle?totalPages-leftPage:leftPage+1,currentPageRight=this.isArabicStyle?currentPageLeft-1:currentPageLeft+1,currentPage=[currentPageLeft];this.isMobile&&FSUtils.isPortrait()||this.isSinglePageView||currentPageLeft<totalPages&&currentPageLeft>1&&currentPage.push(currentPageRight),this.$el.html(this.template({totalPages:totalPages,currentPage:currentPage.join("-")}))}}),ZoomModel=Backbone.Model.extend({defaults:{defaultZoomValue:0,zoomValue:0,maxZoomValue:1,notNeeded:!1}}),DropDownOptionModel=Backbone.Model.extend({defaults:{target:"self",type:"default"}}),ShareOptionModel=DropDownOptionModel.extend({defaults:{type:"link",link:"",label:"",target:"_blank"},initialize:function(){this.setLink()},setLink:function(){var link,pinterestUrl,messages=FlipSnackEmbed.urls.customDomain?ShareOptions.WHITE_LABEL:ShareOptions.FLIPSNACK;if(FlipSnackEmbed.isEditor)this.set("link","#");else switch(this.get("link")||this.set("link",URLPaths.DIRECT_LINK,{silent:!0}),link=this.get("link"),this.get("type")){case"facebook":this.set("link",ShareOptions.FACEBOOK_SHARE_BASE_URL+"?u="+encodeURIComponent(link)+"&t="+encodeURIComponent(FSWidgetModel.gi().flipCollection.get("title")));break;case"twitter":this.set("link",ShareOptions.TWITTER_SHARE_BASE_URL+"?status="+encodeURIComponent(messages.TWITTER_MESSAGE)+" "+encodeURIComponent(link));break;case"pinterest":pinterestUrl=ShareOptions.PINTEREST_SHARE_BASE_URL+"?url="+encodeURIComponent(link)+"&description="+encodeURIComponent(messages.PINTEREST_MESSAGE+FSWidgetModel.gi().flipCollection.get("title"))+"&media="+FSWidgetModel.gi().getFirstPageThumb(),this.set("link",pinterestUrl);break;case"email":this.set("link",ShareOptions.EMAIL_SHARE_BASE_URL+"?subject="+encodeURIComponent(messages.EMAIL_SUBJECT)+"&body="+encodeURIComponent(messages.EMAIL_BODY)+"%0A%0A"+encodeURIComponent(link));break;default:this.set("link",link)}}}),ZoomView=Backbone.View.extend({events:{"mousedown .zoom-slider-btn":"onZoomDragStart","mousedown .zoom-slider":"onSliderClick","click .zoom-min":"handleClickMinus","click .zoom-plus":"handleClickPlus"},template:_.template(MenuTemplates.zoom),className:"drop-down-options zoomView",initialize:function(){this.isDragging=!1,this.zoomButtonTolerance=4,this.zoomSliderTolerance=0,this.zoomStep=10,this.zoomValues=FSUtils.generateZoomValues(0,this.model.get("maxZoomValue"),ZoomView.CONTROLLED_ZOOM_AMOUNT),0===this.model.get("maxZoomValue")&&this.model.set("notNeeded",!0),Backbone.Mediator.sub(WidgetEvent.OPEN_ZOOM_OPTIONS,ZoomButton.prototype.showOptionsPanel,this),Backbone.Mediator.sub(WidgetEvent.ZOOM_CHANGED,this.handleZoomChanged,this),Backbone.Mediator.sub(WidgetEvent.MAX_ZOOM_CHANGED,this.updateMaxZoom,this),Backbone.Mediator.sub(WidgetEvent.ENTER_FULLSCREEN,this.resetZoom,this),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayState",this.handleDisplayModeChange),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayType",this.handleDisplayModeChange),this.listenTo(this.model,"change:zoomValue",this.handleModelZoomChanged),this.listenTo(this.model,"change:maxZoomValue",this.handleModelZoomChanged)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.on("mousedown mouseup",function(e){return!e.isDefaultPrevented()&&(Backbone.Mediator.pub(e.type,e),!0)}),this.zoomSliderBar=this.$el.find(".zoom-slider"),this.zoomSliderBtn=this.$el.find(".zoom-slider-btn"),this.model.get("notNeeded")&&this.$el.hide(),this},onSliderClick:function(e){return 1!==e.which||(this.positionZoomBtn(e),this.onZoomDragStart(e),!0)},handleClickMinus:function(e){if(1!==e.which)return!0;Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:this.model.get("zoomValue")-FSWidgetModel.gi().get("maxZoomValue")/this.zoomStep})},handleClickPlus:function(e){if(1!==e.which)return!0;Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:this.model.get("zoomValue")+FSWidgetModel.gi().get("maxZoomValue")/this.zoomStep})},onZoomDragStart:function(e){return 1!==e.which||(this.isDragging=!0,Backbone.Mediator.sub("mousemove",this.onZoomButtonDrag,this),Backbone.Mediator.sub("dragstop",this.onZoomDragStop,this),Backbone.Mediator.sub("mouseup",this.onZoomDragStop,this),Backbone.Mediator.pub(WidgetEvent.ZOOM_START),!0)},onZoomDragStop:function(){var zoomValue=this.getZoomValue();this.isDragging=!1,this.zoomSliderBtn.blur(),Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:zoomValue}),Backbone.Mediator.pub(WidgetEvent.ZOOM_END),Backbone.Mediator.unsubscribe("mousemove",this.onZoomButtonDrag,this),Backbone.Mediator.unsubscribe("dragstop",this.onZoomDragStop,this),Backbone.Mediator.unsubscribe("mouseup",this.onZoomDragStop,this)},onZoomButtonDrag:function(e){this.isDragging?this.positionZoomBtn(e):this.onZoomDragStop()},positionZoomBtn:function(e){var sliderLeft=this.zoomSliderBar.offset().left+this.zoomSliderTolerance,mousePos=e.pageX-this.zoomButtonTolerance,percent=Math.floor(Math.max(0,Math.min(mousePos-sliderLeft,this.getSliderWidth())))/this.getSliderWidth(),currentZoomValue=this.model.get("defaultZoomValue")+this.model.get("maxZoomValue")*percent,newZoomValue=isNaN(currentZoomValue)?FSWidgetModel.gi().widgetState.get("maxZoomVal"):FSUtils.getClosestZoomValue(this.zoomValues,currentZoomValue);FSWidgetModel.gi().get("currentZoom")!==newZoomValue&&Backbone.Mediator.pub(WidgetEvent.CHANGE_ZOOM,{value:newZoomValue})},setSliderButtonPosition:function(newPosX){this.zoomSliderBtn.css("left",newPosX+this.zoomSliderTolerance+"px")},getSliderButtonPosition:function(){return parseInt(this.zoomSliderBtn.css("left"),10)-this.zoomSliderTolerance},getSliderWidth:function(){return this.model.get("notNeeded")?ZoomView.DEFAULT_SLIDER_WIDTH:this.zoomSliderBar.width()-2*this.zoomButtonTolerance},getZoomValue:function(){var percent=this.getSliderButtonPosition()/this.getSliderWidth(),val=this.model.get("defaultZoomValue")+this.model.get("maxZoomValue")*percent;return val=isNaN(val)?FSWidgetModel.gi().widgetState.get("maxZoomVal"):val},resetZoom:function(){this.model.set("zoomValue",this.model.get("defaultZoomValue"))},handleDisplayModeChange:function(){FSWidgetModel.gi().widgetState.get("displayState")!==DisplayState.NORMAL&&FSWidgetModel.gi().widgetState.get("displayType")!==DisplayType.SMALL||this.resetZoom()},handleZoomChanged:function(obj){var minValue=Math.min(obj.value,this.model.get("maxZoomValue")),finalValue=Math.max(minValue,this.model.get("defaultZoomValue"));this.model.set("zoomValue",finalValue)},handleModelZoomChanged:function(){var percent=this.model.get("zoomValue")/this.model.get("maxZoomValue"),newPos=this.getSliderWidth()*percent;this.setSliderButtonPosition(newPos)},updateMaxZoom:function(){var maxZoom=FSWidgetModel.gi().get("maxZoomValue");this.model.set("maxZoomValue",maxZoom),this.model.set("notNeeded",0===maxZoom),this.zoomValues=FSUtils.generateZoomValues(0,maxZoom,ZoomView.CONTROLLED_ZOOM_AMOUNT)},onPanelClick:function(e){e.stopImmediatePropagation()},closePanel:function(e){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),Backbone.Mediator.pub(WidgetEvent.CLOSE_ZOOM_OPTIONS)},remove:function(){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),this.$el.off(),this.off(),Backbone.Mediator.unsubscribe("mousemove",this.onZoomButtonDrag,this),Backbone.Mediator.unsubscribe("dragstop",this.onZoomDragStop,this),Backbone.Mediator.unsubscribe("mouseup",this.onZoomDragStop,this),Backbone.Mediator.unsubscribe(WidgetEvent.ZOOM_CHANGED,this.handleZoomChanged,this),Backbone.Mediator.unsubscribe(WidgetEvent.MAX_ZOOM_CHANGED,this.updateMaxZoom,this),Backbone.Mediator.unsubscribe(WidgetEvent.OPEN_ZOOM_OPTIONS,ZoomButton.prototype.showOptionsPanel,this),Backbone.View.prototype.remove.apply(this,arguments)}});ZoomView.DEFAULT_SLIDER_WIDTH=70,ZoomView.CONTROLLED_ZOOM_AMOUNT=24;var ClearSearch=Backbone.View.extend({events:{click:"onClick"},template:_.template(MenuTemplates.buttonX),className:"clear-search",render:function(){return this.$el.html(this.template(this.model.attributes)),this},onClick:function(){Backbone.Mediator.pub(WidgetEvent.CLEAR_SEARCH)}}),SearchInputView=Backbone.View.extend({events:{"keydown input":"onKeyDown","focus input":"onFocus","blur input":"onBlur","click .clear-results":"clearSearch",search:"clearSearch"},template:_.template(MenuTemplates.searchInput),className:"search-input",initialize:function(){Backbone.Mediator.sub(WidgetEvent.CHANGE_LANGUAGE,this.setTextDirection,this),this.isPlayerSkin=FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.PLAYER},render:function(){return this.$el.html(this.template({hideClearButton:this.isPlayerSkin?"":"hide-clear-button"})),this.$input=this.$el.find("input"),this.setTextDirection(),this},onKeyDown:function(e){13===e.which?this.setSearchText():8===e.which&&this.$input.val().trim().length<=1&&Backbone.Mediator.pub(WidgetEvent.CLEAR_SEARCH),Backbone.Mediator.pub(WidgetEvent.STOP_AUTOHIDE),e.stopPropagation()},onFocus:function(){Backbone.Mediator.pub(WidgetEvent.STOP_AUTOHIDE)},onBlur:function(){Backbone.Mediator.pub(WidgetEvent.START_AUTOHIDE)},clearSearch:function(){this.$input.val().trim().length<1&&(this.$input.val("").focus(),this.$el.find(".results-nr").text(""),this.model.set("searchText",""),Backbone.Mediator.pub(WidgetEvent.CLEAR_SEARCH))},setSearchText:function(){var searchText=this.$input.val().trim();""!==searchText&&searchText.length>=3&&this.model.set("searchText",searchText)},setTextDirection:function(){FSWidgetModel.gi().get("textDirection")===TextDirection.RIGHT_TO_LEFT?this.$input.addClass("reverse-text"):this.$input.removeClass("reverse-text")},remove:function(){Backbone.Mediator.unsubscribe(WidgetEvent.CHANGE_LANGUAGE,this.setTextDirection,this),Backbone.View.prototype.remove.apply(this,arguments)}}),MenuOptionsPanel=Backbone.View.extend({template:_.template(MenuTemplates.menuOptionsContent),className:"drop-down-options",showOptionsPanel:function(obj){var self=this;null!==MenuOptionsPanel.OPEN_DROPDOWN&&MenuOptionsPanel.OPEN_DROPDOWN.closePanel(),self&&self.model.get("tocData")&&!self.model.get("visible")&&self.model.set("visible",!0),MenuOptionsPanel.OPEN_DROPDOWN=this,setTimeout(function(){$(document).bind("click",self.closePanel)},100)},closePanel:function(e){MenuOptionsPanel.OPEN_DROPDOWN&&MenuOptionsPanel.OPEN_DROPDOWN.model.get("tocData")&&MenuOptionsPanel.OPEN_DROPDOWN.model.get("visible")&&(MenuOptionsPanel.OPEN_DROPDOWN.model.set("visible",!1),Backbone.Mediator.pub(WidgetEvent.CLOSE_TOC)),MenuOptionsPanel.OPEN_DROPDOWN=null,$(document).unbind("click",this.closePanel),$("#flipView").unbind("click",this.closePanel)},remove:function(){$(document).unbind("click",self.closePanel),Backbone.View.prototype.remove.apply(this,arguments)}});MenuOptionsPanel.OPEN_DROPDOWN=null;var ShareOptions=MenuOptionsPanel.extend({id:"share-options",events:{click:"onPanelClick"},initialize:function(){Backbone.Mediator.sub(WidgetEvent.OPEN_SHARE_OPTIONS,this.showOptionsPanel,this),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:shareFaceBook",this.showHideOption),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:shareTwitter",this.showHideOption),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:sharePinterest",this.showHideOption),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:shareEmail",this.showHideOption),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:shareLink",this.showHideOption)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.model.get("shareFaceBook")&&this.initOptions("facebook",MenuTemplates.shareIcons.facebook),this.model.get("shareTwitter")&&this.initOptions("twitter",MenuTemplates.shareIcons.twitter),this.model.get("sharePinterest")&&this.initOptions("pinterest",MenuTemplates.shareIcons.pinterest),this.model.get("shareEmail")&&this.initOptions("email",MenuTemplates.shareIcons.email),this.model.get("shareLink")&&this.initOptions("link",null),this},initOptions:function(type,icon){var link=FSUtils.getDirectlink();this.dropDownView="link"===type?new ShareLinkView({model:new Backbone.Model({link:link,confirmMessage:"Copied"})}):new DropDownOptionView({model:new ShareOptionModel({type:type,icon:icon||link,link:link,parent:this,action:"share"})}),this.$el.find(".content").append(this.dropDownView.render().el)},showHideOption:function(data){var i;for(i in data.changed)data.changed.hasOwnProperty(i)&&this.model.set(i,data.changed[i]);this.$el.find(".content").empty(),this.render()},onPanelClick:function(e){e.stopImmediatePropagation()},closePanel:function(){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),Backbone.Mediator.pub(WidgetEvent.CLOSE_SHARE_OPTIONS)},remove:function(){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),this.dropDownView&&(this.dropDownView.remove(),this.dropDownView=null),Backbone.Mediator.unsubscribe(WidgetEvent.OPEN_SHARE_OPTIONS,this.showOptionsPanel,this),Backbone.View.prototype.remove.apply(this,arguments)}});ShareOptions.FACEBOOK_SHARE_BASE_URL="http://www.facebook.com/sharer.php",ShareOptions.TWITTER_SHARE_BASE_URL="http://twitter.com/intent/tweet",ShareOptions.PINTEREST_SHARE_BASE_URL="//www.pinterest.com/pin/create/button/",ShareOptions.EMAIL_SHARE_BASE_URL="mailto:",ShareOptions.FLIPSNACK={TWITTER_MESSAGE:"Check out this flipbook!",PINTEREST_MESSAGE:"FlipSnack | ",EMAIL_SUBJECT:"I made this great publication on flipsnack.com",EMAIL_BODY:"Check this out: "},ShareOptions.WHITE_LABEL={TWITTER_MESSAGE:"Check out this digital edition!",PINTEREST_MESSAGE:"Digital Edition | ",EMAIL_SUBJECT:"Check out this great publication I found",EMAIL_BODY:"Check this out: "};var TableOfContent=Backbone.View.extend({id:"table-of-contents",template:_.template(MenuTemplates.tableOfContent.content),events:{click:"onPanelClick"},initialize:function(){this.listenTo(this.model,"change:visible",this.toggleOpen),this.listenTo(FSWidgetModel.gi(),"change:height",this.setHeight),Backbone.Mediator.sub(WidgetEvent.OPEN_TOC,this.toggleOpen,this),Backbone.Mediator.sub(WidgetEvent.CLOSE_TOC,this.toggleOpen,this),this.tocHeader=new TocHeader({model:new Backbone.Model}),this.tocBody=new TocBody({model:new Backbone.Model({data:this.model.get("tocData")})})},render:function(){this.$el.html(this.template(this.model.attributes));var contentHeight=FSUtils.isPlayerSkin()?FSWidgetModel.gi().get("height")-LayoutManager.FLIPVIEW_BOTTOM_MARGIN-30:FSWidgetModel.gi().get("height");return this.$el.find(".content").css("height",contentHeight).append(this.tocHeader.render().el),this.model.get("tocData")&&this.model.get("tocData").length&&this.$el.find(".content").append(this.tocBody.render().el),this.toggleOpen(),this},onPanelClick:function(e){e.stopImmediatePropagation()},toggleOpen:function(open){open&&!this.$el.hasClass("open")?this.$el.addClass("open"):!open&&this.$el.hasClass("open")&&this.$el.removeClass("open")},setHeight:function(){var contentHeight=FSUtils.isPlayerSkin()?FSWidgetModel.gi().get("height")-LayoutManager.FLIPVIEW_BOTTOM_MARGIN-30:FSWidgetModel.gi().get("height");this.$el.find(".content").css("height",contentHeight)},remove:function(){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),this.tocHeader&&(this.tocHeader.remove(),this.tocHeader=null),this.tocBody&&(this.tocBody.remove(),this.tocBody=null),Backbone.Mediator.unsubscribe(WidgetEvent.OPEN_TOC,this.showOptionsPanel,this),Backbone.View.prototype.remove.apply(this,arguments)}}),TocHeader=Backbone.View.extend({className:"toc-header",template:_.template(MenuTemplates.tableOfContent.header),initialize:function(){this.closeTOC=new CloseTOC({model:new Backbone.Model})},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.find(".close").append(this.closeTOC.render().el),this},remove:function(){Backbone.View.prototype.remove.apply(this,arguments)}}),TocRow=Backbone.View.extend({events:{click:"onRowClick"},template:_.template(MenuTemplates.tableOfContent.row),className:"toc-row",initialize:function(){var self=this;this.pages=FSWidgetModel.gi().get("collectionData").tocPageLinks,this.pageCorespondent=this.model.get("originalHash")+"_"+this.model.get("page"),this.listenTo(this.model,"change:opened",this.toggleOpened),this.listenTo(this.model,"change:visible",this.showHide),this.listenTo(this.model,"change:selected",this.selectTableRow),Backbone.Mediator.sub(WidgetEvent.DESELECT_TABLE_ROW,this.deselectTableRow,this),this.arrow=new TocArrow({model:new Backbone.Model({opened:this.model.get("opened"),row:this,empty:0===this.model.get("sub").length})}),this.subnodes=this.model.get("sub").map(function(val){return new TocRow({model:new Backbone.Model({title:val.title||"Default title",level:parseInt(self.model.get("level"),10)+1,page:val.pageNumber,originalHash:val.originalHash,sub:val.sub,opened:!1,visible:!1,selected:!1})})})},onRowClick:function(e){e.stopPropagation(),FSWidgetModel.gi().widgetState.get("currentPageIndex")===this.model.get("page")||isNaN(this.pages[this.pageCorespondent])||Backbone.Mediator.pub(WidgetEvent.CHANGE_PAGE,this.pages[this.pageCorespondent]),Backbone.Mediator.pub(WidgetEvent.DESELECT_TABLE_ROW),this.model.set("selected",!0)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.subnodes.length&&this.$el.find(".title").before(this.arrow.render().el),this.$el.find(".row-header").css("padding-left",20*(this.model.get("level")-1)+"px"),this.showHide(),this.createSubnodes(this.$el.find(".subnodes")),this.toggleOpened(),this},toggleOpened:function(){this.subnodes&&this.subnodes.length&&(this.model.get("opened")&&!this.$el.hasClass("opened")?(this.$el.addClass("opened"),this.$el.children(".row-header").addClass("opened"),this.subnodes.forEach(function(row){row.model.set("visible",!0)}),this.arrow.model.set("opened",!0)):!this.model.get("opened")&&this.$el.hasClass("opened")&&(this.$el.removeClass("opened"),this.$el.children(".row-header").removeClass("opened"),this.subnodes.forEach(function(row){row.model.set("visible",!1),row.model.set("opened",!1)}),this.arrow.model.set("opened",!1)))},createSubnodes:function(sub){this.subnodes&&this.subnodes.length&&this.subnodes.forEach(function(row){sub.append(row.render().el)})},showHide:function(){this.model.get("visible")?this.$el.css("display","flex"):this.$el.css("display","none")},selectTableRow:function(){this.model.get("selected")&&!this.$el.hasClass("selected")?(this.$el.addClass("selected"),this.$el.children(".row-header").addClass("selected")):!this.model.get("selected")&&this.$el.hasClass("selected")&&(this.$el.removeClass("selected"),this.$el.children(".row-header").removeClass("selected"))},deselectTableRow:function(){this.model.set("selected",!1)},remove:function(){Backbone.Mediator.unsubscribe(WidgetEvent.DESELECT_TABLE_ROW,this.deselectTableRow,this),this.off(),this.stopListening(),this.subnodes&&this.subnodes.length&&this.subnodes.forEach(function(row){row.remove()}),this.arrow&&this.arrow.remove(),Backbone.View.prototype.remove.apply(this,arguments)}}),TocBody=Backbone.View.extend({className:"toc-body",initialize:function(){var data=this.model.get("data");data&&(this.rows=data.map(function(val){return new TocRow({model:new Backbone.Model({title:val.title,level:val.level,page:val.pageNumber,originalHash:val.originalHash,sub:val.sub,opened:!1,visible:!0,selected:!0})})}))},render:function(){var self=this;return this.rows.forEach(function(row){self.$el.append(row.render().el)}),this.$el.jScrollPane({mouseWheelSpeed:40,hideFocus:!0,autoReinitialise:!0,animateScroll:!0,contentWidth:"0px"}),this},remove:function(){this.rows&&this.rows.length&&this.rows.forEach(function(row){row.remove()}),Backbone.View.prototype.remove.apply(this,arguments)}}),TocArrow=Backbone.View.extend({className:"toc-arrow",events:{click:"onTocArrowClick"},template:_.template(MenuTemplates.tableOfContent.arrow),onTocArrowClick:function(e){e.stopPropagation(),this.model.get("row").model.set("opened",!this.model.get("opened"))},render:function(){return this.$el.html(this.template(this.model.attributes)),this.model.get("empty")&&this.$el.empty(),this},remove:function(){this.off(),this.stopListening(),Backbone.View.prototype.remove.apply(this,arguments)}}),CloseTOC=Backbone.View.extend({events:{click:"onClick"},template:_.template(MenuTemplates.buttonX),className:"clear-toc",render:function(){return this.$el.html(this.template(this.model.attributes)),this},onClick:function(){Backbone.Mediator.pub(WidgetEvent.CLOSE_TOC)}}),SearchResultView=Backbone.View.extend({events:{click:"jumpToPage"},template:_.template(MenuTemplates.searchResult),className:"search-result",initialize:function(){this.setTitle()},render:function(){return this.$el.html(this.template(this.model.attributes)),this},setTitle:function(){this.model.set("title",FSWidgetModel.gi().get("labels").l_pageSearch.replace("#",this.model.get("pageIndex")+1))},jumpToPage:function(){FSWidgetModel.gi().widgetState.get("currentPageIndex")!==this.model.get("pageIndex")&&Backbone.Mediator.pub(WidgetEvent.CHANGE_PAGE,this.model.get("pageIndex"))}}),SearchResults=Backbone.View.extend({template:_.template(MenuTemplates.searchResults),className:"search-results hidden",initialize:function(){this.beforeFoundChars=30,this.afterFoundChars=100,this.searchtext="",this.textResults=[],this.elementTextResults=[],this.foundData=[],this.searchResultsViews=[],this.isPlayerSkin=FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.PLAYER,this.setResultCountText()},render:function(){return this.$el.html(this.template(this.model.attributes)),this},setResultCountText:function(){if(this.isPlayerSkin){var input=this.$el.parent().find(".search-input .results-nr");this.model.set("resultCountText",""),input.text(FSWidgetModel.gi().get("labels").l_playerResults.replace("#",this.foundData.length))}else this.model.set("resultCountText",FSWidgetModel.gi().get("labels").l_resultsFound.replace("#",this.foundData.length))},showResults:function(searchText){""!==searchText&&(this.searchtext=searchText,this.setResults(),this.populateSearchList())},populateSearchList:function(){var self=this;this.setResultCountText(),this.render(),this.clearSearchResultViews(),this.foundData.length&&($.each(this.foundData,function(i,fd){var resultView=new SearchResultView({model:new Backbone.Model(fd)});self.searchResultsViews.push(resultView),self.$el.find(".search-result-list").append(resultView.render().el)}),self.$el.find(".search-result-list").jScrollPane({mouseWheelSpeed:40,hideFocus:!0,autoReinitialise:!0,animateScroll:!0}))},clearSearchResultViews:function(){for(;this.searchResultsViews.length;)this.searchResultsViews.pop().remove(),null},getTextResults:function(searchText){FSWidgetModel.gi().widgetState.get("currentItem").get("pages");var regexp=new RegExp(this.searchtext,"gi"),foundIndexes=[];return $.each(window.textJs,function(pageIndex,pageText){for(var matches=[],match=regexp.exec(pageText);null!=match;)matches.push(match.index),match=regexp.exec(pageText);matches.length&&foundIndexes.push({type:"textJs",pdfidx:parseInt(pageIndex,10),modelIndex:parseInt(pageIndex,10),positions:matches})}),foundIndexes},getElementTextResults:function(){var pages=FSWidgetModel.gi().widgetState.get("currentItem").get("pages"),regexp=new RegExp(this.searchtext,"gi"),foundIndexes=[];return $.each(pages.models,function(pageIndex,p){p.get("customElements")&&$.each(p.get("customElements"),function(elIdx,ce){var match,matches=[],text="",textBox=!1;if(ce.type===ElementType.TEXT&&void 0!==ce.text&&""!==ce.text.toString().trim()||ce.type===ElementType.TEXT_BOX&&ce.nodes&&ce.nodes.length>0){for(ce.type===ElementType.TEXT?text=ce.text:($.each(ce.nodes,function(index,node){text+=node.text.toString()}),textBox=!0),match=regexp.exec(text);null!=match;)matches.push(match.index),match=regexp.exec(text);matches.length&&foundIndexes.push({type:"customElement",elementIndex:elIdx,modelIndex:pageIndex,positions:matches,textBox:textBox})}})}),foundIndexes},setResults:function(){window.textJs&&(this.foundData=[],this.textResults=this.getTextResults(),this.elementTextResults=this.getElementTextResults(),this.formatFoundData())},formatFoundData:function(){var self=this,mergedArray=this.textResults.concat(this.elementTextResults),pages=FSWidgetModel.gi().widgetState.get("currentItem").get("pages").models;mergedArray.length&&$.each(mergedArray,function(i,tr){var textJsText="";"textJs"===tr.type?textJsText=window.textJs[tr.pdfidx]:tr.textBox?(textJsText="",$.each(pages[tr.modelIndex].get("customElements")[tr.elementIndex].nodes,function(i,node){textJsText+=node.text.toString()})):textJsText=pages[tr.modelIndex].get("customElements")[tr.elementIndex].text,$.each(tr.positions,function(j,pos){var beforeText=pos<self.beforeFoundChars?"":textJsText.substr(pos-self.beforeFoundChars,self.beforeFoundChars),afterTextStart=pos+self.searchtext.length,afterTextEnd=afterTextStart+self.afterFoundChars>textJsText.length?textJsText.length-pos:self.afterFoundChars,afterText=textJsText.substr(afterTextStart,afterTextEnd),highlightedText="<b>"+textJsText.substr(pos,self.searchtext.length)+"</b>";self.foundData.push({type:tr.type,pageIndex:tr.modelIndex,html:beforeText+highlightedText+afterText})})}),self.foundData.sort(self.sortByPages)},sortByPages:function(a,b){return a.pageIndex>b.pageIndex?1:a.pageIndex<b.pageIndex?-1:0},remove:function(){this.clearSearchResultViews(),this.$el.empty(),Backbone.View.prototype.remove.apply(this,arguments)}}),SearchOptions=MenuOptionsPanel.extend({events:{click:"onPanelClick"},id:"search-options",initialize:function(){this.pdfItems=[],this.pdfTextsLoaded=[],this.onCurrentItemChanged(),this.searchInput=new SearchInputView({model:new Backbone.Model}),this.searchResults=new SearchResults({model:new Backbone.Model}),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentItem",this.onCurrentItemChanged),this.listenTo(this.searchInput.model,"change:searchText",this.onSearchTextChanged),Backbone.Mediator.sub(WidgetEvent.OPEN_SEARCH_OPTIONS,this.showOptionsPanel,this),Backbone.Mediator.sub(WidgetEvent.CLEAR_SEARCH,this.hideSearchResults,this),Backbone.Mediator.sub(WidgetEvent.RESIZE,this.closePanel,this)},showOptionsPanel:function(){var input=this.searchInput.$el.find("input"),searchText=this.searchInput.model.get("searchText")||"";input.focus(),MenuOptionsPanel.prototype.showOptionsPanel.apply(this,arguments),""!==searchText&&(this.searchInput.model.set("searchText","",{silent:!0}),this.searchInput.model.set("searchText",searchText))},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.find(".content").append(this.searchInput.render().el).append(this.searchResults.render().el),this},onCurrentItemChanged:function(){var textsUrl,currentItem=FSWidgetModel.gi().widgetState.get("currentItem"),_this=this;window.textJs=null,delete window.textJs,Backbone.Mediator.pub(WidgetEvent.CLEAR_SEARCH),FSWidgetModel.gi().widgetSettings.get("mergePdfs")?(this.setPdfItems(),this.pdfItems.length&&!FSWidgetModel.gi().widgetSettings.get("exportVideo")?this.loadAllTexts():this.setTextJs()):"pdf"!==currentItem.get("extension")||currentItem.get("notext")||"failed"===FSWidgetModel.gi().widgetState.get("currentItem").get("textLoadStatus")||FSWidgetModel.gi().widgetSettings.get("exportVideo")||(textsUrl=FlipSnackEmbed.urls.items+currentItem.get("hash")+FlipSnackEmbed.urls.textJS,FSWidgetModel.gi().widgetState.get("currentItem").set("textLoadStatus","loading"),void 0===window["text_"+currentItem.get("hash")]&&(window["text_"+currentItem.get("hash")]=function(data){window.textJs=data}),FSUtils.loadScript(textsUrl,function(){_this.textJsLoaded()},function(){_this.textJSFail()}))},setPdfItems:function(){var items=FSWidgetModel.gi().get("collectionData").collection,_this=this,pages=null;this.pdfItems=[],$.each(items,function(i,item){"pdf"===item.extension&&(pages=item.pageData,_this.pdfItems.push(item),$.each(pages,function(j,page){"pdf"===page.extension&&page.originalHash&&!_this.pdfItems.some(function(it){return it.source===page.originalHash})&&_this.pdfItems.push({source:page.originalHash})}),pages=null)})},setTextJs:function(){var i,pages=FSWidgetModel.gi().widgetState.get("currentItem").get("pages"),pdfTextsLoaded=[];for(i=0;i<this.pdfTextsLoaded.length;i++)pdfTextsLoaded[this.pdfTextsLoaded[i].hash]=this.pdfTextsLoaded[i].textData;window.textJs={},$.each(pages.models,function(pageIndex,page){var textData=pdfTextsLoaded[page.get("originalHash")]||pdfTextsLoaded[page.get("itemHash")]||null,textDataPageIndex=page.get("pdfidx");textData&&textData[textDataPageIndex]&&(page.get("type")===PageType.UPLOADED_PAGE||page.get("type")===PageType.MOVED_PAGE&&page.get("extension")&&"pdf"===page.get("extension"))&&(window.textJs[pageIndex]=$("<textarea />").html(textData[textDataPageIndex]).text())})},loadAllTexts:function(){var item,textUrl,_this=this;this.pdfItems.length?(item=this.pdfItems.shift(),textUrl=FlipSnackEmbed.urls.items+item.source+FlipSnackEmbed.urls.textJS,window["text_"+item.source]=function(data){_this.pdfTextsLoaded.push({hash:item.source,textData:data})},FSUtils.loadScript(textUrl,function(){_this.loadAllTexts()},function(){_this.loadAllTexts()})):this.pdfTextsLoaded.length&&(this.setTextJs(),Backbone.Mediator.pub(WidgetEvent.SEARCH_TEXTS_LOADED))},textJsLoaded:function(){FSWidgetModel.gi().widgetState.get("currentItem").set("textLoadStatus","success"),Backbone.Mediator.pub(WidgetEvent.SEARCH_TEXTS_LOADED)},textJSFail:function(a,b,c){delete window["text_"+FSWidgetModel.gi().widgetState.get("currentItem").get("hash")],FSWidgetModel.gi().widgetState.get("currentItem").set("textLoadStatus","failed")},closePanel:function(){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),Backbone.Mediator.pub(WidgetEvent.CLOSE_SEARCH_OPTIONS)},onPanelClick:function(e){e.stopImmediatePropagation()},onSearchTextChanged:function(model){this.showSearchResults(),this.searchResults.showResults(model.get("searchText"))},showSearchResults:function(){this.searchResults.$el.removeClass("hidden")},hideSearchResults:function(){this.searchResults.$el.addClass("hidden")},remove:function(){this.searchInput.remove(),this.searchInput=null,this.searchResults.remove(),this.searchResults=null,Backbone.Mediator.unsubscribe(WidgetEvent.OPEN_SEARCH_OPTIONS,this.showOptionsPanel,this),Backbone.Mediator.unsubscribe(WidgetEvent.CLEAR_SEARCH,this.hideSearchResults,this),Backbone.Mediator.unsubscribe(WidgetEvent.RESIZE,this.closePanel,this),Backbone.View.prototype.remove.apply(this,arguments)}});SearchOptions.TEXT_JS_LOAD_LIMIT=5;var OptionsButtonView=Backbone.View.extend({className:"menu-btn",events:{click:"onClick"},initialize:function(){Backbone.Mediator.sub(WidgetEvent.CHANGE_LANGUAGE,this.setTextDirection,this),void 0!==this.initializeAppend&&this.initializeAppend()},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$label=this.$el.find("label"),this.setTextDirection(),this},onClick:function(e){this.model.get("open")?this.model.get("optionsPanel").closePanel():this.openOptions(),e.stopImmediatePropagation()},openOptions:function(){this.model.set("open",!0),this.$el.addClass("open"),void 0!==this.openOptionsAppend&&this.openOptionsAppend()},closePanel:function(){this.model.set("open",!1),this.$el.removeClass("open")},setTextDirection:function(){FSWidgetModel.gi().get("textDirection")===TextDirection.RIGHT_TO_LEFT?this.$label.addClass("reverse-text"):this.$label.removeClass("reverse-text")},remove:function(){Backbone.Mediator.unsubscribe(WidgetEvent.CHANGE_LANGUAGE,this.setTextDirection,this),Backbone.View.prototype.remove.apply(this,arguments)}}),ShareButton=OptionsButtonView.extend({events:{click:"onClickShareButton"},template:_.template(MenuTemplates.shareButton),className:"menu-btn share-button",initializeAppend:function(){Backbone.Mediator.sub(WidgetEvent.CLOSE_SHARE_OPTIONS,this.closePanel,this)},openOptionsAppend:function(){Backbone.Mediator.pub(WidgetEvent.OPEN_SHARE_OPTIONS,this)},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_SHARE_OPTIONS,this.closePanel,this),Backbone.View.prototype.remove.apply(this,arguments)},onClickShareButton:function(e){"string"==typeof FSWidgetModel.gi().get("collectionData").trackingId&&FSWidgetModel.gi().get("collectionData").trackingId.length&&!FlipSnackEmbed.isEditor&&Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Share"),OptionsButtonView.prototype.onClick.apply(this,arguments)}}),TocButton=OptionsButtonView.extend({events:{click:"onClickTOCButton"},template:_.template(MenuTemplates.tocButton),className:"menu-btn toc-button",initializeAppend:function(){Backbone.Mediator.sub(WidgetEvent.CLOSE_TOC,this.closePanel,this)},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_TOC,this.closePanel,this),Backbone.View.prototype.remove.apply(this,arguments)},onClickTOCButton:function(e){this.model.get("open")?(Backbone.Mediator.pub(WidgetEvent.CLOSE_TOC,!1),this.model.set("open",!1),this.$el.removeClass("open")):(Backbone.Mediator.pub(WidgetEvent.OPEN_TOC,!0),this.model.set("open",!0),this.$el.addClass("open"))}}),DownloadButton=OptionsButtonView.extend({template:_.template(MenuTemplates.downloadButton),className:"menu-btn download-button",onClick:function(){return FlipSnackEmbed.isEditor?(FSWidgetModel.gi().sendMessage(this.model),!1):(Backbone.Mediator.pub(StatsEvents.REGISTER,{eid:Stats.TYPE.DOWNLOAD_COLLECTION}),Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Download PDF"),!0)}}),PrintButton=OptionsButtonView.extend({template:_.template(MenuTemplates.printButton),className:"menu-btn print-button",onClick:function(){return FlipSnackEmbed.isEditor?(FSWidgetModel.gi().sendMessage(this.model),!1):(Backbone.Mediator.pub(StatsEvents.REGISTER,{eid:Stats.TYPE.PRINT}),Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Print PDF"),!0)}}),SearchButton=OptionsButtonView.extend({template:_.template(MenuTemplates.searchButton),className:"menu-btn search-button",initializeAppend:function(){this.setButtonState(),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentItem",this.setButtonState),Backbone.Mediator.sub(WidgetEvent.CLOSE_SEARCH_OPTIONS,this.closePanel,this),Backbone.Mediator.sub(WidgetEvent.SEARCH_TEXTS_LOADED,this.setButtonState,this)},onChangeSearchState:function(state){"disabled"===state?this.disable():this.enable()},disable:function(){this.$el.addClass("disabled")},enable:function(){this.$el.removeClass("disabled")},openOptionsAppend:function(){Backbone.Mediator.pub(WidgetEvent.OPEN_SEARCH_OPTIONS,this)},setButtonState:function(){var currentItem;this.disable(),FSWidgetModel.gi().widgetSettings.get("mergePdfs")?window.textJs&&this.enable():"pdf"!==(currentItem=FSWidgetModel.gi().widgetState.get("currentItem")).get("extension")||currentItem.get("notext")||"success"!==currentItem.get("textLoadStatus")||this.enable()},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_SEARCH_OPTIONS,this.closePanel,this),Backbone.Mediator.unsubscribe(WidgetEvent.SEARCH_TEXTS_LOADED,this.setButtonState,this)}}),ZoomButton=OptionsButtonView.extend({events:{click:"onClickZoomButton"},template:_.template(MenuTemplates.zoomButton),className:"menu-btn zoom-button",initializeAppend:function(){Backbone.Mediator.sub(WidgetEvent.CLOSE_ZOOM_OPTIONS,this.closePanel,this),Backbone.Mediator.sub(WidgetEvent.MAX_ZOOM_CHANGED,this.updateMaxZoom,this)},openOptionsAppend:function(){Backbone.Mediator.pub(WidgetEvent.OPEN_ZOOM_OPTIONS,this)},showOptionsPanel:function(obj){var self=this;null!==MenuOptionsPanel.OPEN_DROPDOWN&&MenuOptionsPanel.OPEN_DROPDOWN.closePanel(),MenuOptionsPanel.OPEN_DROPDOWN=this,setTimeout(function(){$("#flipView").bind("click",self.closePanel)},100)},isClickOnSlider:function(elem){return!!($(elem).hasClass("zoom-slider-btn")||$(elem).hasClass("content")||$(elem).hasClass("zoom-slider")||$(elem).hasClass("zoom-action"))},updateMaxZoom:function(){FSWidgetModel.gi().get("maxZoomValue")>0?this.$el.show():this.$el.hide()},onClickZoomButton:function(e){this.isClickOnSlider(e.target)||("string"==typeof FSWidgetModel.gi().get("collectionData").trackingId&&FSWidgetModel.gi().get("collectionData").trackingId.length&&!FlipSnackEmbed.isEditor&&Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Zoom"),OptionsButtonView.prototype.onClick.apply(this,arguments))},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_ZOOM_OPTIONS,this.closePanel,this),Backbone.Mediator.unsubscribe(WidgetEvent.MAX_ZOOM_CHANGED,this.updateMaxZoom,this),$("#flipView").unbind("click",self.closePanel)}}),DropDownOptionView=Backbone.View.extend({events:{"click a":"onClick"},template:_.template(MenuTemplates.menuOptionElement),className:"option",render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.addClass(this.model.get("type")),this.model.attributes.icon&&this.$el.find("a").html(this.model.attributes.icon),this},onClick:function(){return!FlipSnackEmbed.isEditor||(FSWidgetModel.gi().sendMessage(this.model),!1)}}),ExitFullScreenButtonView=Backbone.View.extend({events:{click:"onClick"},template:_.template(MenuTemplates.buttonX),className:"menu-btn exit-full-screen-button",initialize:function(){this.listenTo(FSWidgetModel.gi().widgetState,"change:displayState",this.setButtonVisibility)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.setButtonVisibility(),this},onClick:function(){"string"==typeof FSWidgetModel.gi().get("collectionData").trackingId&&FSWidgetModel.gi().get("collectionData").trackingId.length&&!FlipSnackEmbed.isEditor&&Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Close"),Backbone.Mediator.pub(WidgetEvent.EXIT_FULLSCREEN)},setButtonVisibility:function(){FSWidgetModel.gi().widgetState.get("displayState")!==DisplayState.NORMAL?this.$el.css("display","inline-block"):this.$el.hide()},remove:function(){Backbone.View.prototype.remove.apply(this,arguments)}}),PlayerOptionsButtonView=Backbone.View.extend({className:"player-option-btn",events:{click:"onClick"},initialize:function(){Backbone.Mediator.sub(WidgetEvent.CHANGE_LANGUAGE,this.setTextDirection,this),void 0!==this.initializeAppend&&this.initializeAppend()},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$label=this.$el.find("label"),this.setTextDirection(),this},onClick:function(e){this.model.get("open")?this.model.get("optionsPanel").closePanel():this.openOptions(),e.stopImmediatePropagation()},openOptions:function(){this.model.set("open",!0),this.$el.addClass("open"),$("#bottomRight").addClass("hideLabels"),void 0!==this.openOptionsAppend&&this.openOptionsAppend()},closePanel:function(){this.model.set("open",!1),this.$el.removeClass("open"),$("#bottomRight").removeClass("hideLabels")},setTextDirection:function(){FSWidgetModel.gi().get("textDirection")===TextDirection.RIGHT_TO_LEFT?this.$label.addClass("reverse-text"):this.$label.removeClass("reverse-text")},remove:function(){Backbone.Mediator.unsubscribe(WidgetEvent.CHANGE_LANGUAGE,this.setTextDirection,this),Backbone.View.prototype.remove.apply(this,arguments)}}),PlayerFullScreenButton=PlayerOptionsButtonView.extend({events:{click:"onClickFullScreenButton"},template:_.template(MenuTemplates.enterFullscreenPlayer),templateExit:_.template(MenuTemplates.leaveFullscreenPlayer),className:"player-option-btn player-fullscreen-button",initialize:function(){this.listenTo(FSWidgetModel.gi().widgetState,"change:displayState",this.setButtonVisibility)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.setButtonVisibility(),this.$el.css("color","red"),this},onClickFullScreenButton:function(){"string"==typeof FSWidgetModel.gi().get("collectionData").trackingId&&FSWidgetModel.gi().get("collectionData").trackingId.length&&!FlipSnackEmbed.isEditor&&Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Click to read"),Backbone.Mediator.pub(WidgetEvent.ENTER_FULLSCREEN)},setButtonVisibility:function(){FSWidgetModel.gi().widgetState.get("displayState")!==DisplayState.NORMAL?this.$el.html(this.templateExit({label:FSWidgetModel.gi().get("labels").l_exit_fs})):this.$el.html(this.template({label:FSWidgetModel.gi().get("labels").l_enter_fs}))},remove:function(){Backbone.View.prototype.remove.apply(this,arguments)}}),PlayerDownloadButton=PlayerOptionsButtonView.extend({template:_.template(MenuTemplates.downloadBtnPlayer),className:"player-option-btn player-download-button",onClick:function(){return FlipSnackEmbed.isEditor?(FSWidgetModel.gi().sendMessage(this.model),!1):(Backbone.Mediator.pub(StatsEvents.REGISTER,{eid:Stats.TYPE.DOWNLOAD_COLLECTION}),Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Download PDF"),!0)}}),PlayerPrintButton=PlayerOptionsButtonView.extend({template:_.template(MenuTemplates.printBtnPlayer),className:"player-option-btn player-print-button",onClick:function(){return FlipSnackEmbed.isEditor?(FSWidgetModel.gi().sendMessage(this.model),!1):(Backbone.Mediator.pub(StatsEvents.REGISTER,{eid:Stats.TYPE.PRINT}),Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Print PDF"),!0)}}),PlayerSearchButton=PlayerOptionsButtonView.extend({template:_.template(MenuTemplates.searchBtnPlayer),className:"player-option-btn player-search-button",initializeAppend:function(){this.setButtonState(),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentItem",this.setButtonState),Backbone.Mediator.sub(WidgetEvent.CLOSE_SEARCH_OPTIONS,this.closePanel,this),Backbone.Mediator.sub(WidgetEvent.SEARCH_TEXTS_LOADED,this.setButtonState,this)},onChangeSearchState:function(state){"disabled"===state?this.disable():this.enable()},disable:function(){this.$el.addClass("disabled")},enable:function(){this.$el.removeClass("disabled")},openOptionsAppend:function(){Backbone.Mediator.pub(WidgetEvent.OPEN_SEARCH_OPTIONS,this)},setButtonState:function(){var currentItem;this.disable(),FSWidgetModel.gi().widgetSettings.get("mergePdfs")?window.textJs&&this.enable():"pdf"!==(currentItem=FSWidgetModel.gi().widgetState.get("currentItem")).get("extension")||currentItem.get("notext")||"success"!==currentItem.get("textLoadStatus")||this.enable()},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_SEARCH_OPTIONS,this.closePanel,this),Backbone.Mediator.unsubscribe(WidgetEvent.SEARCH_TEXTS_LOADED,this.setButtonState,this)}}),PlayerShareButton=PlayerOptionsButtonView.extend({template:_.template(MenuTemplates.shareBtnPlayer),className:"player-option-btn player-share-button",initializeAppend:function(){Backbone.Mediator.sub(WidgetEvent.CLOSE_SHARE_OPTIONS,this.closePanel,this)},openOptionsAppend:function(){Backbone.Mediator.pub(WidgetEvent.OPEN_SHARE_OPTIONS,this)},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_SHARE_OPTIONS,this.closePanel,this),Backbone.View.prototype.remove.apply(this,arguments)},onClick:function(){"string"==typeof FSWidgetModel.gi().get("collectionData").trackingId&&FSWidgetModel.gi().get("collectionData").trackingId.length&&!FlipSnackEmbed.isEditor&&Tracker.ga(FSWidgetModel.gi().get("collectionHash"),"Share"),OptionsButtonView.prototype.onClick.apply(this,arguments)}}),PlayerTOCButton=PlayerOptionsButtonView.extend({events:{click:"onClickTOCButton"},template:_.template(MenuTemplates.tocBtnPlayer),className:"player-option-btn player-toc-button",initializeAppend:function(){Backbone.Mediator.sub(WidgetEvent.CLOSE_TOC,this.closePanel,this)},remove:function(){this.off(),this.stopListening(),Backbone.Mediator.unsubscribe(WidgetEvent.CLOSE_TOC,this.closePanel,this),Backbone.View.prototype.remove.apply(this,arguments)},onClickTOCButton:function(e){this.model.get("open")?(Backbone.Mediator.pub(WidgetEvent.CLOSE_TOC,!1),this.model.set("open",!1),this.$el.removeClass("open")):(Backbone.Mediator.pub(WidgetEvent.OPEN_TOC,!0),this.model.set("open",!0),this.$el.addClass("open"))}}),ShareLinkView=Backbone.View.extend({events:{click:"onClick"},template:_.template(MenuTemplates.menuOptionLink),className:"option link",initialize:function(){this.confirmationTimer=null},render:function(){return this.$el.html(this.template(this.model.attributes)),this.model.get("link").indexOf("your-account-name")>-1&&this.$el.css("cursor","default"),this},onClick:function(){return!(this.model.get("link").indexOf("your-account-name")>-1)&&(document.querySelector("#share-link-input").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),document.querySelector("#share-link-input").blur(),this.showCopyToClipboardConfirmation(),!1)},showCopyToClipboardConfirmation:function(){clearTimeout(this.confirmationTimer),document.querySelector("#share-link-confirmation").style.opacity=1,this.confirmationTimer=setTimeout(function(){document.querySelector("#share-link-confirmation").style.opacity=0},3e3)},remove:function(){Backbone.View.prototype.remove.apply(this,arguments)}});!function(global){window.MenuController=Backbone.View.extend({events:{mouseover:"handleMouseOver",mouseout:"handleMouseOut"},el:ComponentContainers.MENU,initialize:function(){this.inited=!1,this.zoom=null,this.exitFullscreenButton=null,this.shareButon=null,this.shareOptions=null,this.downloadButton=null,this.printButton=null,this.searchButton=null,this.searchOptions=null,this.zoomButton=null,this.render(),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayType",this.render),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayState",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableDownload",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enablePrint",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:sharePost",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableSearch",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableToc",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:showControls",this.render),this.listenTo(FSWidgetModel.gi(),"change:height",this.onChangeSize),this.listenTo(FSWidgetModel.gi(),"change:width",this.onChangeSize),this.listenTo(FSWidgetModel.gi(),"change:labels",this.render),Backbone.Mediator.sub(WidgetEvent.AUTOHIDE_CONTROLS,this.closeAll,this)},render:function(){var shareOptions=FSWidgetModel.gi().getShareOptions();return FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelfOpened")?this:((this.inited&&FlipSnackEmbed.isEditor||"labels"in FSWidgetModel.gi().changed)&&this.resetMenu(),this.inited||this.canInitMenu()?(this.inited=!0,FSWidgetModel.gi().widgetSettings.get("enableToc")&&this.addTOCButton(),this.shareButon||!shareOptions.sharePost||FSWidgetModel.gi().get("isDownload")||this.addShareButton(shareOptions),!this.downloadButton&&FSWidgetModel.gi().widgetSettings.get("enableDownload")&&FSWidgetModel.gi().get("collectionData").features[FEATURES.DOWNLOAD_PDF]&&this.addDownloadButton(),!this.printButton&&FSWidgetModel.gi().widgetSettings.get("enablePrint")&&FSWidgetModel.gi().get("collectionData").features[FEATURES.DOWNLOAD_PDF]&&this.addPrintButton(),!this.searchButton&&FSWidgetModel.gi().widgetSettings.get("enableSearch")&&this.addSearchButton(),this.zoomButton||FSUtils.isMobileDevice()||this.addZoomButton(),!this.exitFullscreenButton&&FSWidgetModel.gi().widgetSettings.get("showFullScreenButton")&&this.addExitFullScreenButton(),this.hideMenuOnMobile(),this.onChangeSize(),this):this)},resetMenu:function(){this.$el.empty(),this.zoom&&(this.zoom.remove(),this.zoom=null),this.exitFullscreenButton&&(this.exitFullscreenButton.remove(),this.exitFullscreenButton=null),this.shareButon&&(this.shareButon.remove(),this.shareButon=null),this.shareOptions&&(this.shareOptions.closePanel(),this.shareOptions.remove(),this.shareOptions=null),this.downloadButton&&(this.downloadButton.remove(),this.downloadButton=null),this.printButton&&(this.printButton.remove(),this.printButton=null),this.downloadOptions&&(this.downloadOptions.closePanel(),this.downloadOptions.remove(),this.downloadOptions=null),this.searchButton&&(this.searchButton.remove(),this.searchButton=null),this.zoomButton&&(this.zoomButton.remove(),this.zoomButton=null),this.searchOptions&&(this.searchOptions.closePanel(),this.searchOptions.remove(),this.searchOptions=null),this.tocButon&&(this.tocButon.remove(),this.tocButon=null)},onChangeSize:function(){FSWidgetModel.gi().canShowControls()?(this.inited||this.render(),this.$el.addClass("show-controls")):this.$el.removeClass("show-controls")},hideMenuOnMobile:function(){!0===FSWidgetModel.gi().get("isApp")&&this.$el.addClass("mobile-app")},addZoomButton:function(){this.zoom=new ZoomView({model:new ZoomModel({maxZoomValue:FSWidgetModel.gi().get("maxZoomValue")})}),this.zoomButton=new ZoomButton({model:new Backbone.Model({open:!1,optionsPanel:this.zoom,label:FSWidgetModel.gi().get("labels").l_zoom})}),this.$el.append(this.zoomButton.render().el),this.zoomButton.$el.append(this.zoom.render().el)},addTOCButton:function(){this.tocButon||(this.tocButon=new TocButton({model:new Backbone.Model({open:!1,label:FSWidgetModel.gi().get("labels").l_toc})}),this.$el.append(this.tocButon.render().el))},addShareButton:function(options){this.shareOptions=new ShareOptions({model:new Backbone.Model(options)}),this.shareButon=new ShareButton({model:new Backbone.Model({open:!1,optionsPanel:this.shareOptions,label:FSWidgetModel.gi().get("labels").l_share})}),this.$el.append(this.shareButon.render().el),this.shareButon.$el.append(this.shareOptions.render().el)},addDownloadButton:function(){var link=FSWidgetModel.gi().getCollectionDownloadLink();this.downloadButton=new DownloadButton({model:new Backbone.Model({action:"download",label:FSWidgetModel.gi().get("labels").l_download,link:link,target:"_blank"})}),this.$el.append(this.downloadButton.render().el)},addPrintButton:function(){var link=FSWidgetModel.gi().getCollectionDownloadLink(!0);this.printButton=new PrintButton({model:new Backbone.Model({action:"print",label:FSWidgetModel.gi().get("labels").l_print,link:link,target:"_blank"})}),this.$el.append(this.printButton.render().el)},addSearchButton:function(){this.searchOptions=new SearchOptions({model:new Backbone.Model}),this.searchButton=new SearchButton({model:new Backbone.Model({open:!1,optionsPanel:this.searchOptions,label:FSWidgetModel.gi().get("labels").l_search})}),this.$el.append(this.searchButton.render().el),this.searchButton.$el.append(this.searchOptions.render().el)},addExitFullScreenButton:function(){this.exitFullscreenButton=new ExitFullScreenButtonView({model:new Backbone.Model}),this.$el.append(this.exitFullscreenButton.render().el)},canInitMenu:function(){return FSWidgetModel.gi().canShowControls()||FSWidgetModel.gi().widgetState.get("displayType")===DisplayType.LARGE},handleMouseOver:function(){Backbone.Mediator.pub(WidgetEvent.STOP_AUTOHIDE)},handleMouseOut:function(){Backbone.Mediator.pub(WidgetEvent.START_AUTOHIDE)},closeAll:function(){this.shareOptions&&this.shareOptions.closePanel(),this.downloadOptions&&this.downloadOptions.closePanel(),this.searchOptions&&this.searchOptions.closePanel(),this.zoomButton&&this.zoomButton.closePanel(),this.toc&&this.toc.closePanel()},remove:function(){Backbone.Mediator.unsubscribe(WidgetEvent.RESIZE,this.onResize,this),this.resetMenu(),this.searchOptions&&(this.searchOptions.remove(),this.searchOptions=null),this.shareOptions&&(this.shareOptions.remove(),this.shareOptions=null),this.downloadOptions&&(this.downloadOptions.remove(),this.downloadOptions=null),Backbone.View.prototype.remove.apply(this,arguments),Backbone.Mediator.unsubscribe(WidgetEvent.AUTOHIDE_CONTROLS,this.showControllers,this)}}),MenuController._instance=null,MenuController.gi=function(){return MenuController._instance||FSWidgetModel.gi().widgetSettings.get("skinType")!==WidgetSkinType.CLASSIC||(MenuController._instance=new MenuController),MenuController._instance},Backbone.Mediator.sub(WidgetEvent.CONFIG_DONE,function(){FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.CLASSIC&&MenuController.gi()},this),Backbone.Mediator.sub(WidgetEvent.DESTROY,function(){MenuController._instance&&(MenuController.gi().remove(),MenuController._instance=null)},this)}(),function(global){window.PlayerSkinController=Backbone.View.extend({events:{mouseover:"handleMouseOver",mouseout:"handleMouseOut"},el:ComponentContainers.BOTTOM_BAR,initialize:function(){this.inited=!1,this.shareButon=null,this.shareOptions=null,this.downloadButton=null,this.printButton=null,this.searchButton=null,this.searchOptions=null,this.zoomBar=null,this.pageNumber=null,this.fullscreenButton=null,this.seekBar=null,this.render(),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayType",this.render),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayState",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableDownload",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enablePrint",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:sharePost",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableSearch",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:enableToc",this.render),this.listenTo(FSWidgetModel.gi().widgetSettings,"change:showControls",this.render),this.listenTo(FSWidgetModel.gi(),"change:height",this.onChangeSize),this.listenTo(FSWidgetModel.gi(),"change:width",this.onChangeSize),this.listenTo(FSWidgetModel.gi(),"change:labels",this.render),Backbone.Mediator.sub(WidgetEvent.AUTOHIDE_CONTROLS,this.closeAll,this)},render:function(){var shareOptions=FSWidgetModel.gi().getShareOptions();return this.playerNavSlider=this.$el.find("#playerNavSlider"),this.bottomLeft=this.$el.find("#bottomLeft"),this.bottomRight=this.$el.find("#bottomRight"),FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelfOpened")?this:((this.inited&&FlipSnackEmbed.isEditor||"labels"in FSWidgetModel.gi().changed)&&this.resetMenu(),this.inited||this.canInitMenu()||FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.PLAYER?((!0===FSWidgetModel.gi().get("isApp")||FSUtils.isMobileDevice())&&this.playerNavSlider.addClass("mobile-slider"),this.inited=!0,this.seekBar||this.addSeekBar(),this.pageNumber||this.addPageNumber(),this.zoomBar||FSUtils.isMobileDevice()||this.addZoomBar(),FSWidgetModel.gi().widgetSettings.get("enableToc")&&this.addTOCButton(),this.shareButon||!shareOptions.sharePost||FSWidgetModel.gi().get("isDownload")||this.addShareButton(shareOptions),!this.downloadButton&&FSWidgetModel.gi().widgetSettings.get("enableDownload")&&FSWidgetModel.gi().get("collectionData").features[FEATURES.DOWNLOAD_PDF]&&this.addDownloadButton(),!this.printButton&&FSWidgetModel.gi().widgetSettings.get("enablePrint")&&FSWidgetModel.gi().get("collectionData").features[FEATURES.DOWNLOAD_PDF]&&this.addPrintButton(),!this.searchButton&&FSWidgetModel.gi().widgetSettings.get("enableSearch")&&this.addSearchButton(),this.fullscreenButton||this.addFullScreenButton(),this.onChangeSize(),this):this)},resetMenu:function(){this.bottomRight.empty(),this.pageNumber&&(this.pageNumber.remove(),this.pageNumber=null),this.zoomBar&&(this.zoomBar.remove(),this.zoomBar=null),this.fullscreenButton&&(this.fullscreenButton.remove(),this.fullscreenButton=null),this.shareButon&&(this.shareButon.remove(),this.shareButon=null),this.shareOptions&&(this.shareOptions.closePanel(),this.shareOptions.remove(),this.shareOptions=null),this.downloadButton&&(this.downloadButton.remove(),this.downloadButton=null),this.printButton&&(this.printButton.remove(),this.printButton=null),this.searchButton&&(this.searchButton.remove(),this.searchButton=null),this.searchOptions&&(this.searchOptions.closePanel(),this.searchOptions.remove(),this.searchOptions=null),this.tocButon&&(this.tocButon.remove(),this.tocButon=null)},onChangeSize:function(){FSWidgetModel.gi().canShowControls()?(this.inited||this.render(),this.$el.addClass("show-controls")):this.$el.removeClass("show-controls")},addSeekBar:function(){this.seekBar=PlayerNavSliderView.gi(),this.playerNavSlider.append(this.seekBar.render().el)},addPageNumber:function(){var totalPages=FSWidgetModel.gi().widgetState.get("currentItem").get("pages").length,isSinglePageView=FSWidgetModel.gi().widgetSettings.get("singlePageView"),isArabicStyle=FSWidgetModel.gi().widgetSettings.get("arabicStyle"),leftPage=FSWidgetModel.gi().widgetState.get("leftPageIndex")<0?0:FSWidgetModel.gi().widgetState.get("leftPageIndex"),currentPageLeft=isArabicStyle?totalPages-leftPage:leftPage+1,currentPageRight=isArabicStyle?currentPageLeft-1:currentPageLeft+1,currentPage=[currentPageLeft];FSUtils.isMobileDevice()&&FSUtils.isPortrait()||isSinglePageView||currentPageLeft<totalPages&&currentPageLeft>1&&currentPage.push(currentPageRight),this.pageNumber=new PageNumber({model:new Backbone.Model({totalPages:totalPages,currentPage:currentPage.join("-")})}),this.bottomLeft.append(this.pageNumber.render().el)},addZoomBar:function(){this.zoomBar=new ZoomBar({model:new ZoomModel({maxZoomValue:FSWidgetModel.gi().get("maxZoomValue")})}),this.bottomRight.append(this.zoomBar.render().el)},addTOCButton:function(){this.tocButon||(this.tocButon=new PlayerTOCButton({model:new Backbone.Model({label:FSWidgetModel.gi().get("labels").l_toc})}),this.bottomRight.append(this.tocButon.render().el))},addShareButton:function(options){this.shareOptions=new ShareOptions({model:new Backbone.Model(options)}),this.shareButon=new PlayerShareButton({model:new Backbone.Model({open:!1,optionsPanel:this.shareOptions,label:FSWidgetModel.gi().get("labels").l_share})}),this.bottomRight.append(this.shareButon.render().el),this.shareButon.$el.append(this.shareOptions.render().el)},addDownloadButton:function(){var link=FSWidgetModel.gi().getCollectionDownloadLink();this.downloadButton=new PlayerDownloadButton({model:new Backbone.Model({action:"download",label:FSWidgetModel.gi().get("labels").l_download,link:link,target:"_blank"})}),this.bottomRight.append(this.downloadButton.render().el)},addPrintButton:function(){var link=FSWidgetModel.gi().getCollectionDownloadLink(!0);this.printButton=new PlayerPrintButton({model:new Backbone.Model({action:"print",label:FSWidgetModel.gi().get("labels").l_print,link:link,target:"_blank"})}),this.bottomRight.append(this.printButton.render().el)},addSearchButton:function(){this.searchOptions=new PlayerSearchOptions({model:new Backbone.Model}),this.searchButton=new PlayerSearchButton({model:new Backbone.Model({optionsPanel:this.searchOptions,label:FSWidgetModel.gi().get("labels").l_search})}),this.bottomRight.append(this.searchButton.render().el),this.searchButton.$el.append(this.searchOptions.render().el)},addFullScreenButton:function(){this.fullscreenButton=new PlayerFullScreenButton({model:new Backbone.Model({label:FSWidgetModel.gi().get("labels").l_enter_fs})}),this.bottomRight.append(this.fullscreenButton.render().el)},canInitMenu:function(){return FSWidgetModel.gi().canShowControls()||FSWidgetModel.gi().widgetState.get("displayType")===DisplayType.LARGE},handleMouseOver:function(){Backbone.Mediator.pub(WidgetEvent.STOP_AUTOHIDE)},handleMouseOut:function(){Backbone.Mediator.pub(WidgetEvent.START_AUTOHIDE)},closeAll:function(){this.shareOptions&&this.shareOptions.closePanel(),this.searchOptions&&this.searchOptions.closePanel(),this.zoomButton&&this.zoomButton.closePanel(),this.toc&&this.toc.closePanel()},remove:function(){Backbone.Mediator.unsubscribe(WidgetEvent.RESIZE,this.onResize,this),this.resetMenu(),this.searchOptions&&(this.searchOptions.remove(),this.searchOptions=null),this.shareOptions&&(this.shareOptions.remove(),this.shareOptions=null),Backbone.View.prototype.remove.apply(this,arguments),Backbone.Mediator.unsubscribe(WidgetEvent.AUTOHIDE_CONTROLS,this.showControllers,this)}}),PlayerSkinController._instance=null,PlayerSkinController.gi=function(){return PlayerSkinController._instance||FSWidgetModel.gi().widgetSettings.get("skinType")!==WidgetSkinType.PLAYER||(PlayerSkinController._instance=new PlayerSkinController),PlayerSkinController._instance},Backbone.Mediator.sub(WidgetEvent.CONFIG_DONE,function(){FSWidgetModel.gi().widgetSettings.get("skinType")===WidgetSkinType.PLAYER&&PlayerSkinController.gi()},this),Backbone.Mediator.sub(WidgetEvent.DESTROY,function(){PlayerSkinController._instance&&(PlayerSkinController.gi().remove(),PlayerSkinController._instance=null)},this)}();var PlayerSearchOptions=MenuOptionsPanel.extend({events:{click:"onPanelClick","click .clear-results":"closePanel"},id:"search-options",initialize:function(){this.pdfItems=[],this.pdfTextsLoaded=[],this.onCurrentItemChanged(),this.searchInput=new SearchInputView({model:new Backbone.Model}),this.searchResults=new SearchResults({model:new Backbone.Model}),this.listenTo(FSWidgetModel.gi().widgetState,"change:currentItem",this.onCurrentItemChanged),this.listenTo(this.searchInput.model,"change:searchText",this.onSearchTextChanged),Backbone.Mediator.sub(WidgetEvent.OPEN_SEARCH_OPTIONS,this.showOptionsPanel,this),Backbone.Mediator.sub(WidgetEvent.CLEAR_SEARCH,this.hideSearchResults,this)},showOptionsPanel:function(){var input=this.searchInput.$el.find("input"),searchText=this.searchInput.model.get("searchText")||"";input.focus(),MenuOptionsPanel.prototype.showOptionsPanel.apply(this,arguments),""!==searchText&&(this.searchInput.model.set("searchText","",{silent:!0}),this.searchInput.model.set("searchText",searchText))},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.find(".content").append(this.searchInput.render().el).prepend(this.searchResults.render().el),this},onCurrentItemChanged:function(){var textsUrl,currentItem=FSWidgetModel.gi().widgetState.get("currentItem"),_this=this;window.textJs=null,delete window.textJs,Backbone.Mediator.pub(WidgetEvent.CLEAR_SEARCH),FSWidgetModel.gi().widgetSettings.get("mergePdfs")?(this.setPdfItems(),this.pdfItems.length&&!FSWidgetModel.gi().widgetSettings.get("exportVideo")?this.loadAllTexts():this.setTextJs()):"pdf"!==currentItem.get("extension")||currentItem.get("notext")||"failed"===FSWidgetModel.gi().widgetState.get("currentItem").get("textLoadStatus")||FSWidgetModel.gi().widgetSettings.get("exportVideo")||(textsUrl=FlipSnackEmbed.urls.items+currentItem.get("hash")+FlipSnackEmbed.urls.textJS,FSWidgetModel.gi().widgetState.get("currentItem").set("textLoadStatus","loading"),void 0===window["text_"+currentItem.get("hash")]&&(window["text_"+currentItem.get("hash")]=function(data){window.textJs=data}),FSUtils.loadScript(textsUrl,function(){_this.textJsLoaded()},function(){_this.textJSFail()}))},setPdfItems:function(){var items=FSWidgetModel.gi().get("collectionData").collection,_this=this,pages=null;this.pdfItems=[],$.each(items,function(i,item){"pdf"===item.extension&&(pages=item.pageData,_this.pdfItems.push(item),$.each(pages,function(j,page){"pdf"===page.extension&&page.originalHash&&!_this.pdfItems.some(function(it){return it.source===page.originalHash})&&_this.pdfItems.push({source:page.originalHash})}),pages=null)})},setTextJs:function(){var i,pages=FSWidgetModel.gi().widgetState.get("currentItem").get("pages"),pdfTextsLoaded=[];for(i=0;i<this.pdfTextsLoaded.length;i++)pdfTextsLoaded[this.pdfTextsLoaded[i].hash]=this.pdfTextsLoaded[i].textData;window.textJs={},$.each(pages.models,function(pageIndex,page){var textData=pdfTextsLoaded[page.get("originalHash")]||pdfTextsLoaded[page.get("itemHash")]||null,textDataPageIndex=page.get("pdfidx");textData&&textData[textDataPageIndex]&&(page.get("type")===PageType.UPLOADED_PAGE||page.get("type")===PageType.MOVED_PAGE&&page.get("extension")&&"pdf"===page.get("extension"))&&(window.textJs[pageIndex]=$("<textarea />").html(textData[textDataPageIndex]).text())})},loadAllTexts:function(){var item,textUrl,_this=this;this.pdfItems.length?(item=this.pdfItems.shift(),textUrl=FlipSnackEmbed.urls.items+item.source+FlipSnackEmbed.urls.textJS,window["text_"+item.source]=function(data){_this.pdfTextsLoaded.push({hash:item.source,textData:data})},FSUtils.loadScript(textUrl,function(){_this.loadAllTexts()},function(){_this.loadAllTexts()})):this.pdfTextsLoaded.length&&(this.setTextJs(),Backbone.Mediator.pub(WidgetEvent.SEARCH_TEXTS_LOADED))},textJsLoaded:function(){FSWidgetModel.gi().widgetState.get("currentItem").set("textLoadStatus","success"),Backbone.Mediator.pub(WidgetEvent.SEARCH_TEXTS_LOADED)},textJSFail:function(){delete window["text_"+FSWidgetModel.gi().widgetState.get("currentItem").get("hash")],FSWidgetModel.gi().widgetState.get("currentItem").set("textLoadStatus","failed")},closePanel:function(){MenuOptionsPanel.prototype.closePanel.apply(this,arguments),Backbone.Mediator.pub(WidgetEvent.CLOSE_SEARCH_OPTIONS)},onPanelClick:function(e){e.stopImmediatePropagation()},onSearchTextChanged:function(model){this.showSearchResults(),this.searchResults.showResults(model.get("searchText"))},showSearchResults:function(){this.searchResults.$el.removeClass("hidden")},hideSearchResults:function(){this.searchResults.$el.addClass("hidden")},remove:function(){this.searchInput.remove(),this.searchInput=null,this.searchResults.remove(),this.searchResults=null,Backbone.Mediator.unsubscribe(WidgetEvent.OPEN_SEARCH_OPTIONS,this.showOptionsPanel,this),Backbone.Mediator.unsubscribe(WidgetEvent.CLEAR_SEARCH,this.hideSearchResults,this),Backbone.View.prototype.remove.apply(this,arguments)}});PlayerSearchOptions.TEXT_JS_LOAD_LIMIT=5;
//# sourceMappingURL=maps/desktop.min.js.map
